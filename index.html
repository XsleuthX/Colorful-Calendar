<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Colorful Calendar – Year Stream</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --device-w: min(100vw, 440px);
      --device-h: min(96vh, 880px);
      --tile: calc(var(--device-w) / 7);
      --type-xs: 11px;
      --type-sm: 13px;
      --type-md: 16px;
      --type-lg: 20px;
      --type-xl: 24px;
      --header-h: 96px;
      --week-h: 44px;
      --z-topbar: 1200;
      --z-weekbar: 1150;
      --z-drawer: 1100;
      --z-side: 1300;
      --z-search: 1400;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:"Source Sans Pro",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: linear-gradient(135deg,#4EFFDF,#48BBDE,#F47EC6);
      display:flex;align-items:center;justify-content:center;color:#0f172a;
    }

    .app{width:var(--device-w);height:var(--device-h);background:#0B2346;border-radius:16px;overflow:hidden;box-shadow:0 18px 50px rgba(0,0,0,.25);display:flex;flex-direction:column;position:relative}

    .topbar{position:sticky;top:0;z-index:var(--z-topbar);height:var(--header-h);background:#153960;color:#fff;padding:12px 14px;display:flex;flex-direction:column;gap:12px;box-shadow:0 2px 0 rgba(0,0,0,.12)}
    .navrow{display:flex;align-items:center;gap:12px}
    .navrow.controls{display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
    .navrow.controls .left{justify-self:start}
    .navrow.controls .center{justify-self:center}
    .navrow.controls .right{justify-self:end}
    .title{flex:1;text-align:center;font-size:var(--type-xl);font-weight:700}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:rgba(255,255,255,.16);color:#fff;cursor:pointer;line-height:1.1;font-size:var(--type-md)}
    .btn:hover{background:rgba(255,255,255,.22)}
    .btn.icon{width:40px;aspect-ratio:1;display:grid;place-items:center;font-size:18px}

    .year-toggle{display:flex;align-items:center;gap:12px}
    .year-pill{background:#fff;color:#153960;font-weight:800;border-radius:9999px;padding:8px 14px;min-width:88px;text-align:center}

    .weekday-row{position:sticky;top:var(--header-h);z-index:var(--z-weekbar);height:var(--week-h);display:grid;grid-template-columns:repeat(7,1fr);align-items:center;justify-items:center;color:#fff;font-size:var(--type-sm);font-weight:700;background:linear-gradient(180deg, rgba(21,57,96,.98), rgba(21,57,96,.96));padding:0 8px;box-shadow:0 1px 0 rgba(0,0,0,.25)}

    .canvas{position:relative;flex:1;overflow:auto;scroll-behavior:smooth;overscroll-behavior:contain;scrollbar-width:none;-ms-overflow-style:none}
    .canvas::-webkit-scrollbar{width:0;height:0}

    .month-section{position:relative;padding:14px 10px 26px;scroll-margin-top:calc(var(--header-h) + var(--week-h) + 10px)}
    .month-back{position:absolute;inset:0;z-index:0;background-image: var(--tone-gradient),
        repeating-linear-gradient(to right, rgba(255,255,255,.10) 0, rgba(255,255,255,.10) var(--tile), rgba(255,255,255,.04) var(--tile), rgba(255,255,255,.04) calc(var(--tile)*2)),
        repeating-linear-gradient(to bottom, rgba(0,0,0,.0) 0, rgba(0,0,0,.0) var(--tile), rgba(0,0,0,.07) var(--tile), rgba(0,0,0,.07) calc(var(--tile)*2));background-blend-mode: normal, overlay, overlay}
    .month-chip{position:absolute;top:12px;left:50%;transform:translateX(-50%);padding:8px 16px;border-radius:9999px;background:#fff;color:#4b5563;font-size:var(--type-sm);font-weight:800;text-transform:uppercase;letter-spacing:.08em;box-shadow:0 2px 0 rgba(0,0,0,.08);opacity:.35;transition:opacity .2s ease}
    .month-section.active .month-chip{opacity:1}

    .month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:36px}
    .cell{position:relative;min-height:calc(var(--tile) - 2px);display:grid;place-items:center}
    .daynum{position:relative;width:clamp(44px, calc(var(--tile)*0.78), 56px);height:clamp(44px, calc(var(--tile)*0.78), 56px);display:grid;place-items:center;border-radius:50%;background:rgba(255,255,255,.18);color:#fff;font-size:var(--type-md);border:2px solid rgba(255,255,255,.15);cursor:pointer;transition:transform .12s ease}
    .daynum:active{transform:scale(.96)}
    .out .daynum{opacity:.45}
    .today .daynum{background:#fff;color:#153960;font-weight:800;border-color:#fff}
    .selected .daynum{background:#fff;color:#153960;border-color:#fff;box-shadow:0 0 0 4px rgba(255,255,255,.24) inset}
    .event-dot{position:absolute;bottom:6px;right:8px;width:12px;height:12px;border-radius:50%;border:2px solid rgba(255,255,255,.8);background:var(--dot,#fff)}

    .drawer{position:absolute;left:0;right:0;bottom:0;background:rgba(10,24,49,.96);backdrop-filter:saturate(120%) blur(10px);color:#fff;max-height:82%;transform:translateY(110%);transition:transform .28s ease;box-shadow:0 -18px 56px rgba(0,0,0,.55);border-top-left-radius:18px;border-top-right-radius:18px;display:flex;flex-direction:column;z-index:var(--z-drawer)}
    .drawer.open{transform:translateY(0)}
    .drawer-header{position:sticky;top:0;background:inherit;display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.15)}
    .drawer-title{flex:1;font-weight:800;font-size:18px}
    .drawer-close{appearance:none;border:0;background:rgba(255,255,255,.18);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .drawer-body{flex:1;overflow-y:auto;overflow-x:hidden;padding:14px 12px 18px;display:flex;flex-direction:column;gap:14px}

    .event-form{display:grid;gap:12px;grid-template-columns:1fr 1fr;grid-template-areas:
      "title title"
      "dstart dend"
      "tstart tend"
      "location location"
      "color submit"}
    @media (min-width: 430px){
      .event-form{grid-template-columns:1fr 1fr 1fr 1fr;grid-template-areas:
        "title title title title"
        "dstart dstart dend dend"
        "tstart tstart tend tend"
        "location location color submit"}
    }
    .event-form input[type="text"],
    .event-form input[type="date"],
    .event-form input[type="time"],
    .event-form input[type="color"]{min-width:0;width:100%;padding:12px 14px;border-radius:12px;border:0;background:rgba(255,255,255,.14);color:#fff;font-size:15px}
    .title-field{grid-area:title}
    .date-start{grid-area:dstart}
    .date-end{grid-area:dend}
    .time-start{grid-area:tstart}
    .time-end{grid-area:tend}
    .location-field{grid-area:location}
    .color-field{grid-area:color; min-width:56px}
    .submit{grid-area:submit;justify-self:end;appearance:none;border:0;border-radius:12px;padding:10px 12px;background:#fff;color:#153960;font-weight:800;cursor:pointer}

    .day-hours{display:grid;grid-template-columns:82px 1fr;gap:8px 12px}
    .hour-lbl{display:grid;place-items:center;background:rgba(255,255,255,.18);border-radius:10px;padding:8px 0;font-size:12px}
    .hour-slot{background:rgba(255,255,255,.10);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px}
    .event-chip{--chip:#fff;background:var(--chip);color:#0b2346;border-radius:10px;padding:8px 10px;font-size:13px;font-weight:800;display:flex;align-items:center;gap:10px}
    .event-chip small{font-weight:700;opacity:.8}
    .event-chip .actions{margin-left:auto;display:flex;gap:6px}
    .event-chip button{appearance:none;border:0;background:rgba(0,0,0,.15);color:#0b2346;border-radius:8px;padding:4px 8px;cursor:pointer}
    .event-chip.editing{outline:2px dashed #fff;outline-offset:-3px}
    .empty-box{border:2px dashed rgba(255,255,255,.35);border-radius:12px;padding:14px 12px;text-align:center;opacity:.9;grid-column:1 / -1}

    .scrim{position:absolute;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s;z-index:calc(var(--z-side) - 1)}
    .scrim.show{opacity:1;pointer-events:auto}

    .side{position:absolute;top:0;left:0;bottom:0;width:min(88%,360px);transform:translateX(-102%);background:rgba(15,35,70,.98);backdrop-filter:saturate(120%) blur(8px);color:#fff;z-index:var(--z-side);box-shadow:12px 0 40px rgba(0,0,0,.45);display:flex;flex-direction:column}
    .side.open{transform:translateX(0);transition:transform .24s ease}
    .side header{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.15)}
    .side header h3{margin:0;font-size:18px}
    .side .content{padding:14px 16px;display:flex;flex-direction:column;gap:12px}
    .side .group{background:rgba(255,255,255,.08);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .side .group h4{margin:0 0 6px 0;font-size:14px;opacity:.85}
    .side .row{display:flex;gap:8px;flex-wrap:wrap}
    .side .row .btn{background:rgba(255,255,255,.18)}
    .side .note{opacity:.8;font-size:12px}

    .search{position:absolute;inset:0;z-index:var(--z-search);display:none;align-items:flex-start;justify-content:center;padding:10px}
    .search.open{display:flex}
    .search .sheet{margin-top:10px;width:calc(var(--device-w) - 20px);background:rgba(15,35,70,.98);backdrop-filter:saturate(120%) blur(8px);border-radius:14px;box-shadow:0 18px 64px rgba(0,0,0,.45);color:#fff;padding:12px 12px}
    .search .q{width:100%;padding:14px 16px;border-radius:12px;border:0;background:rgba(255,255,255,.14);color:#fff;font-size:16px}
    .search ul{list-style:none;margin:10px 0 0;padding:0;max-height:48vh;overflow:auto}
    .search li{padding:10px 12px;border-radius:10px;display:flex;gap:12px;align-items:center}
    .search li:hover{background:rgba(255,255,255,.12)}
    .search li.active{outline:2px solid rgba(255,255,255,.6)}
    .badge{background:#fff;color:#153960;border-radius:999px;padding:2px 8px;font-weight:800;font-size:12px}
  /* === Edit panel (expand/collapse form) === */
.edit-panel {
  position: sticky; top: 0; z-index: 1;
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; margin:-14px -12px 8px;
  background:rgba(255,255,255,.08);
  border-bottom:1px solid rgba(255,255,255,.15);
  border-top-left-radius:12px; border-top-right-radius:12px;
}
.edit-panel button {
  appearance:none;border:0;border-radius:10px;
  padding:8px 12px;background:rgba(255,255,255,.16);
  color:#fff;font-weight:800;cursor:pointer;
}
.event-form.collapsed { display:none !important; }
[hidden]{display:none !important;}

/* Country selector */
.country-select{
  appearance:none;border:0;border-radius:12px;padding:8px 10px;
  background:rgba(255, 255, 255, 1);color:#153960;font-weight:800;cursor:pointer;
}
.country-select:hover{background:rgba(255,255,255,1)}

/* Calendar holiday icon (top-left), and subtle day color tint */
.cell.holiday .daynum{ color:#FFD166; }
.cell .holiday-icon{position:absolute;left:8px;top:8px;font-size:14px;line-height:1;color:#FFD166;
  text-shadow:0 0 2px rgba(0,0,0,.35);pointer-events:none;z-index:2}

/* Full-width holiday strip at top of drawer */
#drawerHours > .holiday-strip{
  grid-column:1 / -1;
  background:#FFD166;
  color:#153960;
  border-radius:12px;
  padding:10px 12px;
  font-weight:800;
  display:flex; align-items:center; gap:8px; min-height:42px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
#drawerHours > .holiday-strip .tag{
  font-weight:900; background:rgba(255,255,255,.25); padding:2px 6px; border-radius:8px;
}


.cell.sun:not(.out):not(.today):not(.selected) .daynum{
  background:rgba(255,120,140,.22);
  border-color:rgba(255,120,140,.90);
  color:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,.12);
}
.cell.holiday:not(.out):not(.today):not(.selected) .daynum{
  background:rgba(255,209,102,.28);
  border-color:#FFD166;
  color:#153960;
  text-shadow:0 1px 0 rgba(255,255,255,.30);
  box-shadow:0 1px 2px rgba(0,0,0,.12);
}


/* Weekend & Holiday day styling (solid colors) */
.cell.sat:not(.out):not(.today):not(.selected) .daynum,
.cell.sun:not(.out):not(.today):not(.selected) .daynum{
  background:#2EA1FF;          /* weekend: solid azure */
  border-color:#FFFFFF;         /* crisp border */
  color:#FFFFFF;                /* high contrast */
  box-shadow:0 1px 2px rgba(0,0,0,.18);
}
/* Place holiday after weekend so it wins when a holiday falls on weekend */
.cell.holiday:not(.out):not(.today):not(.selected) .daynum{
  background:#FFD166;           /* holiday: solid golden */
  border-color:#B98900;         /* darker gold border */
  color:#153960;                /* readable dark text */
  box-shadow:0 1px 2px rgba(0,0,0,.18);
}


/* Day color context menu */
.context-menu{
  position:fixed; top:0; left:0; width:max-content; height:auto;
  background:rgba(22,36,56,.98); color:#fff;
  border:1px solid rgba(255,255,255,.15); border-radius:8px;
  padding:6px; box-shadow:0 6px 16px rgba(0,0,0,.32);
  z-index:9999; display:none;
}
.context-menu[aria-hidden="false"]{ display:grid; grid-template-columns: 132px auto; gap:8px; align-items:center; max-width:unset; }
.context-menu input[type="color"]{ width:22px; height:22px; padding:0; border:0; background:transparent; cursor:pointer; }
.context-menu button{ appearance:none; border:0; border-radius:6px; padding:6px 8px; font-weight:700; font-size:12px; cursor:pointer; background:rgba(255,255,255,.14); color:#fff; white-space:nowrap; }
.context-menu button:hover{ background:rgba(255,255,255,.22); }


/* Preset swatches */
.context-menu{ width:max-content; }
.context-menu .swatches{ display:flex; flex-wrap:wrap; gap:6px; max-width:200px; margin-right:6px; }
.context-menu .swatch{ width:20px; height:20px; border-radius:5px; padding:0; border:1px solid rgba(255,255,255,.6); cursor:pointer; background:transparent; }
.context-menu .swatch:focus{ outline:2px solid rgba(255,255,255,.7); outline-offset:1px; }


/* Ensure selected day always has black text for visibility */
.cell.selected .daynum{ color:#000000 !important; }


/* Context menu grid layout: swatches (left) + tools (right) */
.context-menu{ width:max-content; }
.context-menu[aria-hidden="false"]{
  display:grid; grid-template-columns: 132px auto; gap:8px; align-items:center;
  max-width:unset;
}
.context-menu .swatches{
  display:grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: 20px;
  gap:6px; width:132px;
}
.context-menu .swatch{
  width:20px; height:20px; border-radius:5px; padding:0;
  border:1px solid rgba(255,255,255,.6); cursor:pointer; background:transparent;
}
.context-menu .tools{ display:flex; align-items:center; gap:10px; }
.context-menu input[type="color"]{ width:22px; height:22px; padding:0; border:0; background:transparent; cursor:pointer; }
.context-menu button{ appearance:none; border:0; border-radius:6px; padding:6px 8px; font-weight:700; font-size:12px; cursor:pointer; background:rgba(255,255,255,.14); color:#fff; white-space:nowrap; }
.context-menu button:hover{ background:rgba(255,255,255,.22); }


    /* Multi-day selection highlight */
    .cell.range:not(.out) .daynum{
      outline:2px solid #FFFFFF;
      box-shadow:0 0 0 2px rgba(0,0,0,.25) inset;
    }
    

/* Single (plain click) selection: solid white pill */
.cell.selected-single .daynum{
  background:#FFFFFF !important;
  border-color:#FFFFFF !important;
  color:#0f2742 !important;
  font-weight:900 !important;
  box-shadow:0 1px 2px rgba(0,0,0,.25);
}
/* Multi (shift+click or drag) selection: rounded cap border */
.cell.selected-multi .daynum{
  background:transparent !important;
  border:2px solid #FFFFFF !important;
  color:#FFFFFF !important;
  border-radius:999px !important;
  font-weight:800;
  box-shadow:0 1px 2px rgba(0,0,0,.25);
}

</style>
</head>
<body>
  <main class="app" aria-label="Calendar application">
    <header class="topbar">
      <nav class="navrow">
        <button class="btn icon" id="menuBtn" aria-label="Menu">≡</button>
        <div class="title">Calendar</div>
        <button class="btn icon" id="searchBtn" aria-label="Search">🔎</button>
      </nav>
      <nav class="navrow controls">
        <div class="left"><button class="btn" id="todayBtn" title="Jump to today">Today</button></div>
        <div class="center">
          <div class="year-toggle" aria-label="Calendar year">
            <button class="btn icon" id="yearPrev" aria-label="Previous year">‹</button>
            <button class="btn year-pill" id="yearLabel" aria-label="Selected year">0000</button>
            <button class="btn icon" id="yearNext" aria-label="Next year">›</button>
          </div>
        </div>
        <div class="right">
  <select id="countrySelect" class="country-select" aria-label="Country">
    
    <option value="SG">🇸🇬 Singapore</option>
    <option value="MY">🇲🇾 Malaysia</option>
    <option value="CN">🇨🇳 China</option>
    <option value="TW">🇹🇼 Taiwan</option>
    <option value="JP">🇯🇵 Japan</option>
    <option value="US">🇺🇸 United States</option>

  </select>
</div>
      </nav>
    </header>
    <div class="weekday-row"><div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div></div>
    <section class="canvas" id="canvas" role="region" aria-live="polite"></section>

    <div class="scrim" id="scrim"></div>

    <aside class="side" id="menuPanel" aria-hidden="true">
      <header>
        <h3>Data & Sync</h3>
        <button class="btn icon" id="menuClose" aria-label="Close">×</button>
      </header>
      <div class="content">
        <div class="group">
          <h4>Export</h4>
          <div class="row">
            <button class="btn" id="exportBtn">Export JSON</button>
          </div>
          <div class="note">Downloads a .json backup of your events.</div>
        </div>
        <div class="group">
          <h4>Import</h4>
          <div class="row">
            <button class="btn" id="importReplaceBtn">Import (replace)</button>
            <button class="btn" id="importMergeBtn">Import (merge)</button>
            <input type="file" id="importFile" accept="application/json" hidden />
          </div>
          <div class="note">Replace overwrites everything. Merge keeps existing events and adds new ones.</div>
        </div>
      </div>
    </aside>

    <div class="search" id="searchOverlay" aria-hidden="true">
      <div class="sheet">
        <input class="q" id="searchInput" type="text" placeholder="Search events or type a date… (Ctrl/Cmd+K)" />
        <ul id="searchList"></ul>
      </div>
    </div>

    <aside class="drawer" id="drawer" aria-hidden="true">
      <div class="drawer-header">
        <div class="drawer-title" id="drawerTitle">Events</div>
        <button class="drawer-close" id="drawerClose">Close</button>
      </div>
      <div class="drawer-body">
        <div class="edit-panel" id="editPanel">
  <button id="editPanelToggle" aria-expanded="false" aria-controls="eventForm">
    Show edit panel ▼
  </button>
</div>
<form class="event-form collapsed" id="eventForm" hidden>
          <input type="text" id="eventTitle" class="title-field" placeholder="Add an event" required />
          <input type="date" id="eventStartDate" class="date-start" />
          <input type="date" id="eventEndDate" class="date-end" />
          <input type="time" id="eventStart" class="time-start" value="09:00" />
          <input type="time" id="eventEnd" class="time-end" value="10:00" />
          <input type="text" id="eventLocation" class="location-field" placeholder="Location" />
          <input type="color" id="eventColor" class="color-field" value="#74FBD6" title="Color" />
          <button class="submit" id="submitBtn" type="submit">Add</button>
        </form>
        <div class="day-hours" id="drawerHours"></div>
      </div>
    </aside>
  </main>

<script>
(function(){
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const dows = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
  const tones = [
    ['#56D7C7','#49A7D2'],['#E5A4E3','#C26BD4'],['#7FE3A4','#4CC5A2'],['#F1E184','#E2B76E'],
    ['#FFD36A','#F7A062'],['#FF9E7A','#F26F8C'],['#F478B9','#D25FAE'],['#C07AF1','#875DD1'],
    ['#7A7FEF','#4E67C8'],['#F8D86E','#F08E6C'],['#EC6F8E','#D84C9E'],['#4660B9','#2A85A4']
  ];

  const STORAGE_KEY = 'yearStreamEventsV1';
  const canvas = document.getElementById('canvas');
  const drawer = document.getElementById('drawer');
  const drawerTitle = document.getElementById('drawerTitle');
  const drawerHours = document.getElementById('drawerHours');
  const form = document.getElementById('eventForm');

let isEditPanelOpen = false;
function setEditPanel(open){
  isEditPanelOpen = !!open;
  const formEl = document.getElementById('eventForm');
  if (formEl){
    formEl.classList.toggle('collapsed', !isEditPanelOpen);
    try{ formEl.toggleAttribute('hidden', !isEditPanelOpen); }catch(e){}
  }
  const toggleBtn = document.getElementById('editPanelToggle');
  if (toggleBtn){
    toggleBtn.setAttribute('aria-expanded', String(isEditPanelOpen));
    toggleBtn.textContent = isEditPanelOpen ? 'Hide edit panel ▲' : 'Show edit panel ▼';
  }
}
const editPanel = document.getElementById('editPanel');
const editPanelToggle = document.getElementById('editPanelToggle');

document.addEventListener('DOMContentLoaded', ()=>{
  const toggleBtn = document.getElementById('editPanelToggle');
  if (toggleBtn){
    toggleBtn.addEventListener('click', ()=> setEditPanel(!isEditPanelOpen));
    toggleBtn.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); setEditPanel(!isEditPanelOpen); }
    });
  }
});


  const titleInput = document.getElementById('eventTitle');
  const startDateInput = document.getElementById('eventStartDate');
  const endDateInput = document.getElementById('eventEndDate');
  const startInput = document.getElementById('eventStart');
  const endInput = document.getElementById('eventEnd');
  const locationInput = document.getElementById('eventLocation');
  const colorInput = document.getElementById('eventColor');
  const submitBtn = document.getElementById('submitBtn');
  const todayBtn = document.getElementById('todayBtn');
  const yearPrev = document.getElementById('yearPrev');
  const yearNext = document.getElementById('yearNext');
  const yearLabel = document.getElementById('yearLabel');
  const menuBtn = document.getElementById('menuBtn');
  const menuPanel = document.getElementById('menuPanel');
  const menuClose = document.getElementById('menuClose');
  const scrim = document.getElementById('scrim');
  const exportBtn = document.getElementById('exportBtn');
  const importReplaceBtn = document.getElementById('importReplaceBtn');
  const importMergeBtn = document.getElementById('importMergeBtn');
  const importFile = document.getElementById('importFile');
  const searchBtn = document.getElementById('searchBtn');
  const searchOverlay = document.getElementById('searchOverlay');
  const searchInput = document.getElementById('searchInput');
  const searchList = document.getElementById('searchList');

  const state = { year: new Date().getFullYear(), drawerDate: null };
  let monthEls = [];
  let dateToCell = new Map();
  let selectedCell = null;
  let editing = null; // { key, id, chipEl }

  const pad = n => String(n).padStart(2,'0');
  const keyOf = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const isSameDate = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
  const toYMD = (d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const parseYMD = (s)=>{ const [y,m,d] = s.split('-').map(Number); const dt = new Date(y, (m||1)-1, d||1); dt.setHours(0,0,0,0); return dt; };
  const uid = ()=> 'e' + Math.random().toString(36).slice(2,8) + Date.now().toString(36);

  /* === Holidays (offline baked) + Country state === */
  const HOLIDAYS = {
    SG: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-29', name:"Chinese New Year (Day 1)"},
        {date:'2025-01-30', name:"Chinese New Year (Day 2)"},
        {date:'2025-03-31', name:"Hari Raya Puasa"},
        {date:'2025-04-18', name:"Good Friday"},
        {date:'2025-05-01', name:"Labour Day"},
        {date:'2025-05-12', name:"Vesak Day"},
        {date:'2025-06-07', name:"Hari Raya Haji"},
        {date:'2025-08-09', name:"National Day"},
        {date:'2025-10-20', name:"Deepavali"},
        {date:'2025-12-25', name:"Christmas Day"}
      ]
    }
    ,MY: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-29', name:"Chinese New Year (Day 1)"},
        {date:'2025-01-30', name:"Chinese New Year (Day 2)"},
        {date:'2025-03-31', name:"Hari Raya Aidilfitri (Day 1)"},
        {date:'2025-04-01', name:"Hari Raya Aidilfitri (Day 2)"},
        {date:'2025-05-01', name:"Labour Day"},
        {date:'2025-05-12', name:"Wesak Day"},
        {date:'2025-06-02', name:"Agong's Birthday"},
        {date:'2025-06-07', name:"Hari Raya Haji"},
        {date:'2025-06-27', name:"Awal Muharram"},
        {date:'2025-08-31', name:"Merdeka Day"},
        {date:'2025-09-05', name:"Maulidur Rasul"},
        {date:'2025-09-16', name:"Malaysia Day"},
        {date:'2025-10-20', name:"Deepavali"},
        {date:'2025-12-25', name:"Christmas Day"}
      ]
    }
    ,CN: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-28', name:"Spring Festival Holiday"},
        {date:'2025-01-29', name:"Spring Festival Holiday"},
        {date:'2025-01-30', name:"Spring Festival Holiday"},
        {date:'2025-01-31', name:"Spring Festival Holiday"},
        {date:'2025-02-01', name:"Spring Festival Holiday"},
        {date:'2025-02-02', name:"Spring Festival Holiday"},
        {date:'2025-02-03', name:"Spring Festival Holiday"},
        {date:'2025-02-04', name:"Spring Festival Holiday"},
        {date:'2025-04-04', name:"Qingming Festival"},
        {date:'2025-04-05', name:"Qingming Festival"},
        {date:'2025-04-06', name:"Qingming Festival"},
        {date:'2025-05-01', name:"Labor Day Holiday"},
        {date:'2025-05-02', name:"Labor Day Holiday"},
        {date:'2025-05-03', name:"Labor Day Holiday"},
        {date:'2025-05-04', name:"Labor Day Holiday"},
        {date:'2025-05-05', name:"Labor Day Holiday"},
        {date:'2025-05-31', name:"Dragon Boat Festival"},
        {date:'2025-06-01', name:"Dragon Boat Festival"},
        {date:'2025-06-02', name:"Dragon Boat Festival"},
        {date:'2025-10-01', name:"National Day / Mid-Autumn"},
        {date:'2025-10-02', name:"National Day / Mid-Autumn"},
        {date:'2025-10-03', name:"National Day / Mid-Autumn"},
        {date:'2025-10-04', name:"National Day / Mid-Autumn"},
        {date:'2025-10-05', name:"National Day / Mid-Autumn"},
        {date:'2025-10-06', name:"National Day / Mid-Autumn"},
        {date:'2025-10-07', name:"National Day / Mid-Autumn"},
        {date:'2025-10-08', name:"National Day / Mid-Autumn"}
      ]
    }
    ,TW: {
      2025: [
        {date:'2025-01-01', name:"Republic Day"},
        {date:'2025-01-27', name:"Lunar New Year Holiday"},
        {date:'2025-01-28', name:"Lunar New Year's Eve"},
        {date:'2025-01-29', name:"Lunar New Year Day"},
        {date:'2025-01-30', name:"Lunar New Year Holiday"},
        {date:'2025-01-31', name:"Lunar New Year Holiday"},
        {date:'2025-02-01', name:"Lunar New Year Holiday"},
        {date:'2025-02-02', name:"Lunar New Year Holiday"},
        {date:'2025-02-28', name:"Peace Memorial Day"},
        {date:'2025-04-04', name:"Children's Day & Tomb Sweeping Day"},
        {date:'2025-05-01', name:"Labor Day (private sector)"},
        {date:'2025-05-31', name:"Dragon Boat Festival"},
        {date:'2025-10-06', name:"Mid-Autumn Festival"},
        {date:'2025-10-10', name:"National Day"}
      ]
    }
    ,JP: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-13', name:"Coming of Age Day"},
        {date:'2025-02-11', name:"National Foundation Day"},
        {date:'2025-02-23', name:"Emperor's Birthday"},
        {date:'2025-02-24', name:"Emperor's Birthday (Observed)"},
        {date:'2025-03-20', name:"Vernal Equinox Day"},
        {date:'2025-04-29', name:"Shōwa Day"},
        {date:'2025-05-03', name:"Constitution Memorial Day"},
        {date:'2025-05-04', name:"Greenery Day"},
        {date:'2025-05-05', name:"Children's Day"},
        {date:'2025-05-06', name:"Holiday (Observed)"},
        {date:'2025-07-21', name:"Marine Day"},
        {date:'2025-08-11', name:"Mountain Day"},
        {date:'2025-09-15', name:"Respect for the Aged Day"},
        {date:'2025-09-23', name:"Autumnal Equinox Day"},
        {date:'2025-10-13', name:"Sports Day"},
        {date:'2025-11-03', name:"Culture Day"},
        {date:'2025-11-23', name:"Labor Thanksgiving Day"},
        {date:'2025-11-24', name:"Labor Thanksgiving (Observed)"}
      ]
    }
    ,US: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-20', name:"Martin Luther King Jr. Day"},
        {date:'2025-02-17', name:"Washington's Birthday"},
        {date:'2025-05-26', name:"Memorial Day"},
        {date:'2025-06-19', name:"Juneteenth National Independence Day"},
        {date:'2025-07-04', name:"Independence Day"},
        {date:'2025-09-01', name:"Labor Day"},
        {date:'2025-10-13', name:"Columbus Day"},
        {date:'2025-11-11', name:"Veterans Day"},
        {date:'2025-11-27', name:"Thanksgiving Day"},
        {date:'2025-12-25', name:"Christmas Day"}
      ]
    }

  };
  let currentCountry = localStorage.getItem('country') || 'SG';
  const countrySelect = document.getElementById('countrySelect');
  if (countrySelect){ countrySelect.value = currentCountry; }

  function getHoliday(country, d){
    const key = (typeof d === 'string') ? d : keyOf(d);
    const year = Number(key.slice(0,4));
    const list = (HOLIDAYS[country] && HOLIDAYS[country][year]) || [];
    const hit = list.find(h => h.date === key);
    return hit ? hit.name : null;
  }
  function setHolidayIcon(cell, on){
    cell.classList.toggle('holiday', !!on);
    cell.querySelectorAll('.holiday-icon').forEach(n=>n.remove());
  }
  function decorateMonthHolidays(){
    // iterate through currently built cells for this year
    dateToCell.forEach((cell, key)=>{
      if(!key.startsWith(String(state.year))) return;
      const isHol = !!getHoliday(currentCountry, key);
      setHolidayIcon(cell, isHol);
    if(dayColors[key]) applyDayColor(cell, dayColors[key]);
    });
  }

  function monthMatrix(y,m){ const first = new Date(y,m,1); const start = addDays(first, -first.getDay()); const grid=[]; for(let i=0;i<42;i++) grid.push(addDays(start,i)); return grid; }
  function loadEvents(){ let data={}; try{ data = JSON.parse(localStorage.getItem(STORAGE_KEY))||{} }catch(e){ data = {} } Object.keys(data).forEach(k=>{ data[k].forEach(ev=>{ if(!ev.id) ev.id = uid(); }); }); return data; }
  function saveEvents(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); }

  let events = loadEvents();

  
  /* === Personalized Day Colors === */
  const COLOR_KEY = 'DAY_COLORS';
  function loadDayColors(){ try{ return JSON.parse(localStorage.getItem(COLOR_KEY))||{} }catch(e){ return {} } }
  function saveDayColors(){ localStorage.setItem(COLOR_KEY, JSON.stringify(dayColors)); }
  let dayColors = loadDayColors();

  function hexToRgb(hex){ const m = hex.replace('#',''); const n = parseInt(m,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
  function luminance(hex){ const {r,g,b} = hexToRgb(hex); const sr=[r,g,b].map(v=>{v/=255; return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4)}); return 0.2126*sr[0]+0.7152*sr[1]+0.0722*sr[2]; }
  function pickText(hex){ try{ return luminance(hex) > 0.5 ? '#153960' : '#FFFFFF'; }catch(e){ return '#FFFFFF'; } }
  function applyDayColor(cell, hex){
    const btn = cell.querySelector('.daynum'); if(!btn) return;
    if(hex){
      btn.style.background = hex;
      btn.style.borderColor = '#FFFFFF';
      btn.style.color = pickText(hex);
      cell.classList.add('custom');
    }else{
      btn.style.background = ''; btn.style.borderColor = ''; btn.style.color = ''; cell.classList.remove('custom');
    }
  }

  let colorMenu, colorPicker, colorClear, colorTargetKey=null, colorTargetCell=null;
  function ensureColorMenu(){
    colorMenu = document.getElementById('dayColorMenu');
    colorPicker = document.getElementById('dayColorPicker');
    colorClear = document.getElementById('dayColorClear');
    if(!colorMenu || !colorPicker || !colorClear) return;
    if(!colorMenu.dataset.ready){
      colorPicker.addEventListener('input', ()=>{
        const keys = getSelectedKeys();
        const val = colorPicker.value;
        if(keys.length){
          keys.forEach(k=>{ dayColors[k]=val; const cell = dateToCell.get(k); if(cell) applyDayColor(cell, val); });
          saveDayColors();
        } else if(colorTargetKey && colorTargetCell){
          dayColors[colorTargetKey]=val; saveDayColors(); applyDayColor(colorTargetCell, val);
        }
      });
      colorClear.addEventListener('click', ()=>{
        const keys = getSelectedKeys();
        if(keys.length){
          keys.forEach(k=>{ delete dayColors[k]; const cell = dateToCell.get(k); if(cell) applyDayColor(cell, null); });
          saveDayColors();
        } else if(colorTargetKey && colorTargetCell){
          delete dayColors[colorTargetKey]; saveDayColors(); applyDayColor(colorTargetCell, null);
        }
        closeDayColorMenu();
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDayColorMenu(); });
      document.addEventListener('click', (e)=>{
        if(colorMenu.getAttribute('aria-hidden')==='false' && !colorMenu.contains(e.target)) closeDayColorMenu();
      }, true);
      colorMenu.dataset.ready = '1';

      // init swatches
      const swatchWrap = document.getElementById('dayColorSwatches');
      if(swatchWrap && !swatchWrap.dataset.ready){
        swatchWrap.querySelectorAll('.swatch').forEach(btn=>{
        const c = btn.dataset.color; if(c) btn.style.background = c;
        btn.addEventListener('click', ()=>{
          const keys = getSelectedKeys();
          const val = c;
          if(keys.length){
            keys.forEach(k=>{ dayColors[k]=val; const cell = dateToCell.get(k); if(cell) applyDayColor(cell, val); });
            saveDayColors();
          }else if(colorTargetKey && colorTargetCell){
            dayColors[colorTargetKey]=val; saveDayColors(); applyDayColor(colorTargetCell, val);
          }
          closeDayColorMenu();
        });
      });
        swatchWrap.dataset.ready = '1';
      }
    }
  }
  function openDayColorMenu(cell, key, x, y){
    ensureColorMenu(); if(!colorMenu) return;
    colorTargetCell = cell; colorTargetKey = key;
    colorPicker.value = dayColors[key] || '#2EA1FF';
    colorMenu.style.right = '';
    colorMenu.style.bottom = '';
    colorMenu.style.left = Math.min(x, window.innerWidth-300) + 'px';
    colorMenu.style.top  = Math.min(y, window.innerHeight-80) + 'px';
    colorMenu.setAttribute('aria-hidden','false'); colorMenu.hidden = false;
  }
  function closeDayColorMenu(){
    if(!colorMenu) return;
    colorMenu.setAttribute('aria-hidden','true'); colorMenu.hidden = true;
    colorTargetCell=null; colorTargetKey=null;
  }

  /* === Selection model (single click vs shift+click vs drag) === */
  let primaryKey = null;          // single-click selection
  const multiKeys = new Set();    // additive shift+click or drag selection
  let isDragging = false;
  let dragAnchorKey = null;

  function clearSelection(){
    primaryKey = null; multiKeys.clear();
    refreshSelectionClasses();
  }
  function selectSingle(key){
    primaryKey = key; multiKeys.clear();
    refreshSelectionClasses();
  }
  function addMulti(key){
    multiKeys.add(key);
    refreshSelectionClasses();
  }
  function keysMinMax(){
    const arr = Array.from(multiKeys);
    if(primaryKey) arr.push(primaryKey);
    if(arr.length===0) return null;
    arr.sort();
    return {start: arr[0], end: arr[arr.length-1]};
  }
  function updateDrawerFromSelection(){
    const mm = keysMinMax();
    if(mm && typeof startDateInput!=='undefined' && startDateInput && endDateInput){
      startDateInput.value = mm.start;
      endDateInput.value = mm.end;
    }
  }
  function refreshSelectionClasses(){
    // strip old classes
    dateToCell.forEach((cell)=>{ cell.classList.remove('selected-single','selected-multi','range'); });
    // apply current
    if(primaryKey){ const cell = dateToCell.get(primaryKey); if(cell) cell.classList.add('selected-single'); }
    multiKeys.forEach(k=>{ const cell = dateToCell.get(k); if(cell) cell.classList.add('selected-multi'); });
    updateDrawerFromSelection();
  }
  function setDragRange(toKey){
    if(!dragAnchorKey) return;
    // fill multiKeys with contiguous range between anchor and toKey
    multiKeys.clear();
    const a = parseYMD(dragAnchorKey), b = parseYMD(toKey);
    const dir = a <= b ? 1 : -1;
    let d = dir===1 ? new Date(a) : new Date(b);
    const end = dir===1 ? b : a;
    while(true){
      multiKeys.add(keyOf(d));
      if(d.getTime() === end.getTime()) break;
      d.setDate(d.getDate()+1);
    }
    primaryKey = null;
    refreshSelectionClasses();
  }

  function getSelectedKeys(){
    const arr = Array.from(multiKeys || []);
    if (typeof primaryKey !== 'undefined' && primaryKey) arr.push(primaryKey);
    return Array.from(new Set(arr)).sort();
  }
function buildYear(){
    yearLabel.textContent = state.year;
    canvas.innerHTML = '';
    monthEls = []; dateToCell.clear(); selectedCell = null;
    const today = new Date();
    for(let m=0;m<12;m++){
      const sec = document.createElement('section'); sec.className = 'month-section'; sec.dataset.month = m;
      const back = document.createElement('div'); back.className = 'month-back'; back.style.setProperty('--tone-gradient', `linear-gradient(180deg, ${tones[m][0]}, ${tones[m][1]})`); sec.appendChild(back);
      const chip = document.createElement('div'); chip.className = 'month-chip'; chip.textContent = months[m]; sec.appendChild(chip);
      const grid = document.createElement('div'); grid.className = 'month-grid';
      const mat = monthMatrix(state.year, m);
      mat.forEach(d=>{
        const cell = document.createElement('div'); cell.className='cell'; cell.dataset.date = keyOf(d);
        if(d.getMonth()!==m) cell.classList.add('out');
        if(isSameDate(d,today)) cell.classList.add('today');
        if(d.getMonth()===m){ const __dow=d.getDay(); if(__dow===0) cell.classList.add('sun'); else if(__dow===6) cell.classList.add('sat'); }
        const btn = document.createElement('button'); btn.className='daynum'; btn.type='button'; btn.textContent = d.getDate(); btn.ariaLabel = d.toDateString();
        
        // New selection handlers
        btn.addEventListener('mousedown', (e)=>{
          if(e.button!==0) return;
          if(e.shiftKey){ /* start additive range drag */ isDragging = true; dragAnchorKey = keyOf(d); setDragRange(dragAnchorKey); }
          else { /* start contiguous drag interpreted as multi */ isDragging = true; dragAnchorKey = keyOf(d); setDragRange(dragAnchorKey); }
          e.preventDefault();
        });
        btn.addEventListener('mouseenter', (e)=>{
          if(!isDragging) return;
          setDragRange(keyOf(d));
        });
        btn.addEventListener('mouseup', (e)=>{
          if(!isDragging) return;
          isDragging = false;
        });
        btn.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const k = keyOf(d);
          if(ev.shiftKey){
            addMulti(k);
          }else{
            selectSingle(k);
          }
          openDrawer(d);
        });
btn.addEventListener('contextmenu', (e)=>{ e.preventDefault(); openDayColorMenu(cell, keyOf(d), e.clientX, e.clientY); });
        cell.appendChild(btn); grid.appendChild(cell);
        const k = keyOf(d); dateToCell.set(k, cell);
        if(events[k] && events[k].length){ setMarker(cell, events[k][0].color); }
        if(getHoliday(currentCountry, d)){ setHolidayIcon(cell, true); }
        if(dayColors[k]) applyDayColor(cell, dayColors[k]);
      });
      sec.appendChild(grid);
      canvas.appendChild(sec); monthEls.push(sec);
    }
    setActiveMonthByScroll();
  }

  function selectCell(cell){
    if(selectedCell) selectedCell.classList.remove('selected');
    selectedCell = cell; if(selectedCell) selectedCell.classList.add('selected');
  }

  function setActiveMonthByScroll(){
    const viewportTop = canvas.scrollTop;
    const viewportMid = viewportTop + canvas.clientHeight * 0.25;
    let closest = null; let bestDist = Infinity;
    monthEls.forEach(sec=>{ const dist = Math.abs(sec.offsetTop - viewportMid); if(dist < bestDist){ bestDist = dist; closest = sec; } });
    monthEls.forEach(sec=> sec.classList.toggle('active', sec===closest));
  }
  canvas.addEventListener('scroll', setActiveMonthByScroll, {passive:true});
  document.addEventListener('mouseup', (e)=>{ if(isDragging){ isDragging=false; } });
  canvas.addEventListener('click', (e)=>{ if(e.target===canvas){ clearSelection(); } });
  function openDrawer(date){
  exitEditMode();
    state.drawerDate = new Date(date);
    drawerTitle.textContent = `${dows[date.getDay()]} · ${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
    const mmSel = keysMinMax();
    if(mmSel){ startDateInput.value = mmSel.start; endDateInput.value = mmSel.end; }
    else { startDateInput.value = toYMD(date); endDateInput.value = toYMD(date); }
    
    const now = new Date();
    startInput.value = String(now.getHours()).padStart(2,'0') + ':00';
    endInput.value = String((now.getHours()+1)%24).padStart(2,'0') + ':00';
    titleInput.value = ''; locationInput.value=''; colorInput.value = '#74FBD6';
    renderDayHours(date);
  drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
  }
  function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); exitEditMode(); }

  function renderDayHours(date){
    drawerHours.innerHTML = '';
    const holName = getHoliday(currentCountry, date);
    if(holName){
      const strip = document.createElement('div'); strip.className='holiday-strip';
      strip.innerHTML = `<span class="tag">Public Holiday</span> ${holName}`;
      drawerHours.appendChild(strip);
    }
    const key = keyOf(date); const list = events[key] || [];
    if(!list.length){
      const boxL = document.createElement('div'); boxL.className='empty-box'; boxL.textContent='Empty Schedule';
      drawerHours.appendChild(boxL);
      return;
    }
    const items = list.map(e=>e).sort((a,b)=> a.start.localeCompare(b.start));
    items.forEach((e)=>{
      const lab = document.createElement('div'); lab.className='hour-lbl'; lab.textContent = e.start;
      const slot = document.createElement('div'); slot.className='hour-slot';
      const chip = document.createElement('div'); chip.className='event-chip'; chip.style.setProperty('--chip', e.color || '#fff');
      const loc = e.location ? ` • ${e.location}` : '';
      chip.innerHTML = `<strong>${e.title}</strong> <small>${e.start}–${e.end}${loc}</small>`;
      const actions = document.createElement('div'); actions.className='actions';
      const edit = document.createElement('button'); edit.textContent='✎'; edit.title='Edit';
      edit.onclick = ()=>{ enterEditMode(key, e.id, chip, e); };
      const del = document.createElement('button'); del.textContent='×'; del.title='Delete';
      del.onclick = ()=>{ deleteEvent(key, e.id); };
      actions.appendChild(edit); actions.appendChild(del); chip.appendChild(actions);
      slot.appendChild(chip);
      drawerHours.appendChild(lab); drawerHours.appendChild(slot);
    });
  }

  function setMarker(cell, color){
    cell.querySelectorAll('.event-dot').forEach(n=>n.remove());
    const dot = document.createElement('span'); dot.className='event-dot'; dot.style.setProperty('--dot', color||'#fff');
    cell.appendChild(dot);
  }

  function updateMarkerForKey(key){
    const cell = dateToCell.get(key);
    if(!cell) return;
    cell.querySelectorAll('.event-dot').forEach(n=>n.remove());
    if(events[key] && events[key].length){ setMarker(cell, events[key][0].color); } else { /* keep event marker removed if no events */ }
    // refresh holiday icon state
    const isHol = !!getHoliday(currentCountry, key);
    setHolidayIcon(cell, isHol);
  }

  function deleteEvent(key, id){
    const list = events[key]; if(!list) return;
    const idx = list.findIndex(ev=>ev.id===id);
    if(idx>-1){ list.splice(idx,1); if(!list.length) delete events[key]; saveEvents(); }
    if(state.drawerDate && keyOf(state.drawerDate)===key) renderDayHours(state.drawerDate);
    updateMarkerForKey(key);
    if(editing && editing.key===key && editing.id===id){ exitEditMode(); }
  }

  function addEventToRange(startDate, endDate, evt){
    const s = parseYMD(toYMD(startDate));
    const e = parseYMD(toYMD(endDate));
    for(let d=new Date(s); d<=e; d=addDays(d,1)){
      const k = keyOf(d);
      if(!events[k]) events[k]=[];
      events[k].push({...evt, id: uid()});
      updateMarkerForKey(k);
    }
  }

  function enterEditMode(key, id, chipEl, e){
  try{ setEditPanel(true); }catch(e){}
    exitEditMode();
    editing = { key, id, chipEl };
    chipEl.classList.add('editing');
    submitBtn.textContent = 'Edit';
    titleInput.value = e.title || '';
    startDateInput.value = toYMD(state.drawerDate);
    endDateInput.value = toYMD(state.drawerDate);
    startInput.value = e.start || '09:00';
    endInput.value = e.end || '10:00';
    locationInput.value = e.location || '';
    colorInput.value = e.color || '#74FBD6';
  }

  function exitEditMode(){
    if(editing){ editing.chipEl.classList.remove('editing'); }
    editing = null; submitBtn.textContent = 'Add';
  }

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    if(!state.drawerDate) return;
    const sDate = startDateInput.value ? parseYMD(startDateInput.value) : state.drawerDate;
    const eDate = endDateInput.value ? parseYMD(endDateInput.value) : sDate;
    const evt = { title: titleInput.value.trim(), start: startInput.value, end: endInput.value, color: colorInput.value, location: locationInput.value.trim() };
    if(!evt.title) return;

    if(editing){
      deleteEvent(editing.key, editing.id);
      addEventToRange(sDate, eDate, evt);
      saveEvents();
      state.drawerDate = sDate; renderDayHours(state.drawerDate);
      exitEditMode();
    } else {
      addEventToRange(sDate, eDate, evt); saveEvents();
      state.drawerDate = sDate; renderDayHours(state.drawerDate);
    }

    titleInput.value='';
    });

  document.getElementById('drawerClose').addEventListener('click', closeDrawer);
  
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if(searchOverlay.classList.contains('open')) closeSearch();
      else if(menuPanel.classList.contains('open')) closeMenu();
      // else closeDrawer();  // disabled: drawer only closes via its Close button
    }
  });

  todayBtn.addEventListener('click', ()=>{
    const today = new Date();
    if (today.getFullYear() !== state.year){
      state.year = today.getFullYear();
      buildYear();

    }
    const m = today.getMonth();
    monthEls[m].scrollIntoView({behavior:'smooth', block:'start'});
    setTimeout(()=> setActiveMonthByScroll(), 300);
  });

  yearPrev.addEventListener('click', ()=>{ state.year--; buildYear(); decorateMonthHolidays(); canvas.scrollTop = 0; });
  yearNext.addEventListener('click', ()=>{ state.year++; buildYear(); decorateMonthHolidays(); canvas.scrollTop = 0; });

  /* Country selector */
  if (countrySelect){
    countrySelect.addEventListener('change', ()=>{
      currentCountry = countrySelect.value;
      localStorage.setItem('country', currentCountry);
      decorateMonthHolidays();
      if(state.drawerDate) renderDayHours(state.drawerDate);
    });
  }


  /* Data & Sync (Menu) */
  function openMenu(){ menuPanel.classList.add('open'); scrim.classList.add('show'); }
  function closeMenu(){ menuPanel.classList.remove('open'); scrim.classList.remove('show'); }
  menuBtn.addEventListener('click', openMenu);
  menuClose.addEventListener('click', closeMenu);
  scrim.addEventListener('click', ()=>{
    if(menuPanel.classList.contains('open')) closeMenu();
    if(searchOverlay.classList.contains('open')) closeSearch();
  });

  function exportJSON(){
    const payload = { events, dayColors, country: currentCountry };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    const now = new Date();
    const fname = `calendar-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.json`;
    a.href = URL.createObjectURL(blob); a.download = fname; a.click(); URL.revokeObjectURL(a.href);
  }
  exportBtn.addEventListener('click', exportJSON);

  let importMode = 'replace';
  importReplaceBtn.addEventListener('click', ()=>{ importMode='replace'; importFile.click(); });
  importMergeBtn.addEventListener('click', ()=>{ importMode='merge'; importFile.click(); });
  importFile.addEventListener('change', ()=>{
    const file = importFile.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(data && data.events){
          if(importMode==='replace'){ events = {}; dayColors = {}; }
          for(const [k, arr] of Object.entries(data.events||{})){
            if(!Array.isArray(arr)) continue;
            if(!events[k]) events[k] = [];
            arr.forEach(ev=>{ if(!ev.id) ev.id = uid(); events[k].push(ev); });
          }
          for(const [k, val] of Object.entries(data.dayColors||{})){
            if(val) dayColors[k] = val; else delete dayColors[k];
          }
          if(data.country){ currentCountry = data.country; if(countrySelect) countrySelect.value = currentCountry; }
          saveEvents(); saveDayColors(); buildYear(); decorateMonthHolidays(); closeMenu();
        } else {
          if(importMode==='replace'){ events = {}; }
          for(const [k, arr] of Object.entries(data||{})){
            if(!Array.isArray(arr)) continue;
            if(!events[k]) events[k] = [];
            arr.forEach(ev=>{ if(!ev.id) ev.id = uid(); events[k].push(ev); });
          }
          saveEvents(); buildYear(); decorateMonthHolidays(); closeMenu();
        }
      }catch(err){ alert('Invalid JSON.'); }
      importFile.value='';
    };
    reader.readAsText(file);
  });

  /* Search overlay */
  function openSearch(){ searchOverlay.classList.add('open'); searchOverlay.setAttribute('aria-hidden','false'); searchInput.value=''; renderSearch(''); setTimeout(()=>searchInput.focus(), 0); }
  function closeSearch(){ searchOverlay.classList.remove('open'); searchOverlay.setAttribute('aria-hidden','true'); }
  searchBtn.addEventListener('click', openSearch);
  document.addEventListener('keydown', (e)=>{
    const mod = e.ctrlKey || e.metaKey;
    if(mod && e.key.toLowerCase()==='k'){ e.preventDefault(); openSearch(); }
  });

  function fuzzyScore(q, s){
    q=q.trim().toLowerCase(); s=(s||'').toLowerCase();
    if(!q) return 0;
    let qi=0, score=0, last=-1;
    for(let i=0;i<s.length && qi<q.length;i++){
      if(s[i]===q[qi]){
        score += (last>=0 ? Math.max(2 - (i-last-1)*0.15, 0.2) : 1.0);
        last=i; qi++;
      }
    }
    return qi===q.length ? score : 0;
  }
  function parseQuickDate(q){
    q=q.trim().toLowerCase(); if(!q) return null;
    if(q==='today'){ return new Date(); }
    if(/^\d{4}-\d{2}-\d{2}$/.test(q)){ const d=parseYMD(q); return d; }
    const mname = months.map(m=>m.toLowerCase());
    for(let i=0;i<mname.length;i++){
      const re = new RegExp(`^${mname[i].slice(0,3)}[a-z]*\\s+(\\d{1,2})$`);
      const m = q.match(re);
      if(m){ const d = new Date(state.year, i, Number(m[1])); d.setHours(0,0,0,0); return d; }
    }
    return null;
  }
  function formatDate(d){ return `${dows[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`; }
  function buildSearchItems(){ const items=[]; for(const [k,list] of Object.entries(events)){ const d=parseYMD(k); for(const e of list){ items.push({k, d, e}); } } return items; }

  let selIndex = -1;
  function renderSearch(q){
    const listEl = searchList; listEl.innerHTML=''; selIndex = -1;
    const items = buildSearchItems();
    const results = [];
    const jumpDate = parseQuickDate(q);
    if(jumpDate){ results.push({type:'jump', d:jumpDate, label:`Go to ${formatDate(jumpDate)}`, score:999}); }
    if(q.trim()){
      items.forEach(({k,d,e})=>{
        const text = `${e.title} ${e.location||''}`;
        const sc = fuzzyScore(q, text);
        if(sc>0){ results.push({type:'event', k, d, e, score:sc}); }
      });
    }
    results.sort((a,b)=> b.score - a.score);
    if(!results.length){ const li=document.createElement('li'); li.innerHTML='<span class="badge">No results</span>'; listEl.appendChild(li); return; }
    results.slice(0,50).forEach((r,idx)=>{
      const li = document.createElement('li');
      if(r.type==='jump'){
        li.innerHTML = `<span class="badge">Jump</span> ${r.label}`;
        li.onclick = ()=>{ jumpToDate(r.d); closeSearch(); };
      } else {
        const time = (r.e.start||'').padEnd(5,'0');
        const label = `${formatDate(r.d)} — ${r.e.title}` + (r.e.location?` • ${r.e.location}`:'');
        li.innerHTML = `<span class="badge">${time}</span> ${label}`;
        li.onclick = ()=>{ jumpToDate(r.d); closeSearch(); };
      }
      if(idx===0) { li.classList.add('active'); selIndex=0; }
      listEl.appendChild(li);
    });
  }

  searchInput.addEventListener('input', (e)=> renderSearch(e.target.value));
  searchInput.addEventListener('keydown', (e)=>{
    const items = Array.from(searchList.querySelectorAll('li'));
    if(e.key==='ArrowDown'){
      e.preventDefault();
      if(items.length){
        items[selIndex]?.classList.remove('active');
        selIndex = Math.min(items.length-1, selIndex+1);
        items[selIndex].classList.add('active');
        items[selIndex].scrollIntoView({block:'nearest'});
      }
    }
    else if(e.key==='ArrowUp'){
      e.preventDefault();
      if(items.length){
        items[selIndex]?.classList.remove('active');
        selIndex = Math.max(0, selIndex-1);
        items[selIndex].classList.add('active');
        items[selIndex].scrollIntoView({block:'nearest'});
      }
    }
    else if(e.key==='Enter'){
      e.preventDefault();
      if(items.length && selIndex>=0){ items[selIndex].click(); }
    }
    else if(e.key==='Escape'){ closeSearch(); }
  });

  function jumpToDate(date){
    if(date.getFullYear() !== state.year){ state.year = date.getFullYear(); buildYear(); }
    const m = date.getMonth();
    monthEls[m].scrollIntoView({behavior:'smooth', block:'start'});
    const k = keyOf(date); const cell = dateToCell.get(k);
    if(cell){ selectCell(cell); openDrawer(date); }
  }

  buildYear();
  decorateMonthHolidays();
  
})();
</script>

<div id="dayColorMenu" class="context-menu" aria-hidden="true" hidden>
  <div class="swatches" id="dayColorSwatches">
    <button class="swatch" data-color="#74FBD6" title="Mint"></button>
    <button class="swatch" data-color="#2EA1FF" title="Azure"></button>
    <button class="swatch" data-color="#A88BEB" title="Lavender"></button>
    <button class="swatch" data-color="#FF9EC4" title="Pink"></button>
    <button class="swatch" data-color="#FFD166" title="Amber"></button>
    <button class="swatch" data-color="#7CF29C" title="Lime"></button>
    <button class="swatch" data-color="#6C63FF" title="Indigo"></button>
    <button class="swatch" data-color="#FF7A59" title="Coral"></button>
  </div>
  <div class="tools" id="dayColorTools">
    <input type="color" id="dayColorPicker" value="#2EA1FF" />
    <button id="dayColorClear" type="button">Clear</button>
  </div>
</div>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Colorful Calendar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --device-w: min(100vw, 440px);
      --gantt-w: min(60vw, 860px);
      --gcol: 20px; /* gantt day column width */
      --device-h: min(96vh, 880px);
      --tile: calc(var(--device-w) / 7);
      --type-xs: 11px;
      --type-sm: 13px;
      --type-md: 16px;
      --type-lg: 20px;
      --type-xl: 24px;
      --header-h: 96px;
      --week-h: 44px;
      --z-topbar: 1200;
      --z-weekbar: 1150;
      --z-drawer: 1100;
      --z-side: 1300;
      --z-search: 1400;
    

--row-h: 36px;
--bar-h: 22px;
--gantt-font-size: 12px;
--gantt-font-family: Source Sans Pro, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
--gantt-font-weight: 900;
--gantt-font-color: ;
      --gantt-left-w: 260px;
}

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:"Source Sans Pro",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: linear-gradient(135deg,#4EFFDF,#48BBDE,#F47EC6);
      display:flex;align-items:center;justify-content:center;color:#0f172a;
    }

    .app{width:calc(var(--device-w) + var(--gantt-w) + 28px);height:var(--device-h);background:#0B2346;border-radius:16px;overflow:hidden;box-shadow:0 18px 50px rgba(0,0,0,.25);display:flex;flex-direction:column;position:relative}

    .topbar{position:sticky;top:0;z-index:var(--z-topbar);height:var(--header-h);background:#153960;color:#fff;padding:12px 14px;display:flex;flex-direction:column;gap:12px;box-shadow:0 2px 0 rgba(0,0,0,.12)}
    .navrow{display:flex;align-items:center;gap:12px}
    .navrow.controls{display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
    .navrow.controls .left{justify-self:start}
    .navrow.controls .center{justify-self:center}
    .navrow.controls .right{justify-self:end}
    .title{flex:1;text-align:center;font-size:var(--type-xl);font-weight:700}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:rgba(255,255,255,.16);color:#fff;cursor:pointer;line-height:1.1;font-size:var(--type-md)}
    .btn:hover{background:rgba(255,255,255,.22)}
    .btn.icon{width:40px;aspect-ratio:1;display:grid;place-items:center;font-size:18px}

    .year-toggle{display:flex;align-items:center;gap:12px}
    .year-pill{background:#fff;color:#153960;font-weight:800;border-radius:9999px;padding:8px 14px;min-width:88px;text-align:center}

    .weekday-row{position:sticky;top:var(--header-h);z-index:var(--z-weekbar);height:var(--week-h);display:grid;grid-template-columns:repeat(7,1fr);align-items:center;justify-items:center;color:#fff;font-size:var(--type-sm);font-weight:700;background:linear-gradient(180deg, rgba(21,57,96,.98), rgba(21,57,96,.96));padding:0 8px;box-shadow:0 1px 0 rgba(0,0,0,.25)}

    .canvas{position:relative;flex:1;overflow:auto;scroll-behavior:smooth;overscroll-behavior:contain;scrollbar-width:none;-ms-overflow-style:none}
    .canvas::-webkit-scrollbar{width:0;height:0}

    .month-section{position:relative;padding:14px 10px 26px;scroll-margin-top:calc(var(--header-h) + var(--week-h) + 10px)}
    .month-back{position:absolute;inset:0;z-index:0;background-image: var(--tone-gradient),
        repeating-linear-gradient(to right, rgba(255,255,255,.10) 0, rgba(255,255,255,.10) var(--tile), rgba(255,255,255,.04) var(--tile), rgba(255,255,255,.04) calc(var(--tile)*2)),
        repeating-linear-gradient(to bottom, rgba(0,0,0,.0) 0, rgba(0,0,0,.0) var(--tile), rgba(0,0,0,.07) var(--tile), rgba(0,0,0,.07) calc(var(--tile)*2));background-blend-mode: normal, overlay, overlay}
    .month-chip{position:absolute;top:12px;left:50%;transform:translateX(-50%);padding:8px 16px;border-radius:9999px;background:#fff;color:#4b5563;font-size:var(--type-sm);font-weight:800;text-transform:uppercase;letter-spacing:.08em;box-shadow:0 2px 0 rgba(0,0,0,.08);opacity:.35;transition:opacity .2s ease}
    .month-section.active .month-chip{opacity:1}

    .month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:36px}
    .cell{position:relative;min-height:calc(var(--tile) - 2px);display:grid;place-items:center}
    .daynum{position:relative;width:clamp(44px, calc(var(--tile)*0.78), 56px);height:clamp(44px, calc(var(--tile)*0.78), 56px);display:grid;place-items:center;border-radius:50%;background:rgba(255,255,255,.18);color:#fff;font-size:var(--type-md);border:2px solid rgba(255,255,255,.15);cursor:pointer;transition:transform .12s ease}
    .daynum:active{transform:scale(.96)}
    .out .daynum{opacity:.45}
    .today .daynum{background:#fff;color:#153960;font-weight:800;border-color:#fff}
    .selected .daynum{background:#fff;color:#153960;border-color:#fff;box-shadow:0 0 0 4px rgba(255,255,255,.24) inset}
    .event-dot{position:absolute;bottom:6px;right:8px;width:12px;height:12px;border-radius:50%;border:2px solid rgba(255,255,255,.8);background:var(--dot,#fff)}

    .drawer{position:absolute;left:0;right:0;bottom:0;background:rgba(10,24,49,.96);backdrop-filter:saturate(120%) blur(10px);color:#fff;max-height:82%;transform:translateY(110%);transition:transform .28s ease;box-shadow:0 -18px 56px rgba(0,0,0,.55);border-top-left-radius:18px;border-top-right-radius:18px;display:flex;flex-direction:column;z-index:var(--z-drawer)}
    .drawer.open{transform:translateY(0)}
    .drawer-header{position:sticky;top:0;background:inherit;display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.15)}
    .drawer-title{flex:1;font-weight:800;font-size:18px}
    .drawer-close{appearance:none;border:0;background:rgba(255,255,255,.18);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .drawer-body{flex:1;overflow-y:auto;overflow-x:hidden;padding:14px 12px 18px;display:flex;flex-direction:column;gap:14px}

    .event-form{display:grid;gap:12px;grid-template-columns:1fr 1fr;grid-template-areas:
      "title title"
      "dstart dend"
      "tstart tend"
      "location location"
      "proj stage"
      "task task"
      "color submit"}
    @media (min-width: 430px){
  .event-form{grid-template-columns:1fr 1fr 1fr 1fr;grid-template-areas:
    "title title title title"
    "dstart dstart dend dend"
    "tstart tstart tend tend"
    "location location location location"
    "proj proj stage stage"
    "task task task task"
    "color submit submit submit"}
}
    .event-form input[type="text"],
    .event-form input[type="date"],
    .event-form input[type="time"],
    .event-form input[type="color"]{min-width:0;width:100%;padding:12px 14px;border-radius:12px;border:0;background:rgba(255,255,255,.14);color:#fff;font-size:15px}
    .title-field{grid-area:title}
    #taskProject{grid-area:proj}
    #taskStage{grid-area:stage}
    .task-flag{grid-area:task}
    .date-start{grid-area:dstart}
    .date-end{grid-area:dend}
    .time-start{grid-area:tstart}
    .time-end{grid-area:tend}
    .location-field{grid-area:location}
    .color-field{grid-area:color; min-width:56px}
    .submit{grid-area:submit;justify-self:end;appearance:none;border:0;border-radius:12px;padding:10px 12px;background:#fff;color:#153960;font-weight:800;cursor:pointer}
    .submit-row{grid-area:submit;display:flex;justify-content:flex-end;gap:8px;align-items:center}
    .submit.danger{background:#FF6B6B;color:#fff;}

    .day-hours{display:grid;grid-template-columns:82px 1fr;gap:8px 12px}
    .hour-lbl{display:grid;place-items:center;background:rgba(255,255,255,.18);border-radius:10px;padding:8px 0;font-size:12px}
    .hour-slot{background:rgba(255,255,255,.10);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px}
    .event-chip{--chip:#fff;background:var(--chip);color:#0b2346;border-radius:10px;padding:8px 10px;font-size:13px;font-weight:800;display:flex;align-items:center;gap:10px}
    .event-chip small{font-weight:700;opacity:.8}
    .event-chip .actions{margin-left:auto;display:flex;gap:6px}
    .event-chip button{appearance:none;border:0;background:rgba(0,0,0,.15);color:#0b2346;border-radius:8px;padding:4px 8px;cursor:pointer}
    .event-chip.editing{outline:2px dashed #fff;outline-offset:-3px}
    .empty-box{border:2px dashed rgba(255,255,255,.35);border-radius:12px;padding:14px 12px;text-align:center;opacity:.9;grid-column:1 / -1}

    .scrim{position:absolute;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .2s;z-index:calc(var(--z-side) - 1)}
    .scrim.show{opacity:1;pointer-events:auto}

    .side{position:absolute;top:0;left:0;bottom:0;width:min(88%,360px);transform:translateX(-102%);background:rgba(15,35,70,.98);backdrop-filter:saturate(120%) blur(8px);color:#fff;z-index:var(--z-side);box-shadow:12px 0 40px rgba(0,0,0,.45);display:flex;flex-direction:column}
    .side.open{transform:translateX(0);transition:transform .24s ease}
    .side header{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.15)}
    .side header h3{margin:0;font-size:18px}
    .side .content{padding:14px 16px;display:flex;flex-direction:column;gap:12px}
    .side .group{background:rgba(255,255,255,.08);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .side .group h4{margin:0 0 6px 0;font-size:14px;opacity:.85}
    .side .row{display:flex;gap:8px;flex-wrap:wrap}
    .side .row .btn{background:rgba(255,255,255,.18)}
    .side .note{opacity:.8;font-size:12px}

    .search{position:absolute;inset:0;z-index:var(--z-search);display:none;align-items:flex-start;justify-content:center;padding:10px}
    .search.open{display:flex}
    .search .sheet{margin-top:10px;width:calc(var(--device-w) - 20px);background:rgba(15,35,70,.98);backdrop-filter:saturate(120%) blur(8px);border-radius:14px;box-shadow:0 18px 64px rgba(0,0,0,.45);color:#fff;padding:12px 12px}
    .search .q{width:100%;padding:14px 16px;border-radius:12px;border:0;background:rgba(255,255,255,.14);color:#fff;font-size:16px}
    .search ul{list-style:none;margin:10px 0 0;padding:0;max-height:48vh;overflow:auto}
    .search li{padding:10px 12px;border-radius:10px;display:flex;gap:12px;align-items:center}
    .search li:hover{background:rgba(255,255,255,.12)}
    .search li.active{outline:2px solid rgba(255,255,255,.6)}
    .badge{background:#fff;color:#153960;border-radius:999px;padding:2px 8px;font-weight:800;font-size:12px}
  /* === Edit panel (expand/collapse form) === */
.edit-panel {
  position: sticky; top: 0; z-index: 1;
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; margin:-14px -12px 8px;
  background:rgba(255,255,255,.08);
  border-bottom:1px solid rgba(255,255,255,.15);
  border-top-left-radius:12px; border-top-right-radius:12px;
}
.edit-panel button {
  appearance:none;border:0;border-radius:10px;
  padding:8px 12px;background:rgba(255,255,255,.16);
  color:#fff;font-weight:800;cursor:pointer;
}
.event-form.collapsed { display:none !important; }
[hidden]{display:none !important;}

/* Calendar holiday icon (top-left), and subtle day color tint */
.cell.holiday .daynum{ color:#FFD166; }
.cell .holiday-icon{position:absolute;left:8px;top:8px;font-size:14px;line-height:1;color:#FFD166;
  text-shadow:0 0 2px rgba(0,0,0,.35);pointer-events:none;z-index:2}

/* Full-width holiday strip at top of drawer */
#drawerHours > .holiday-strip{
  grid-column:1 / -1;
  background:#FFD166;
  color:#153960;
  border-radius:12px;
  padding:10px 12px;
  font-weight:800;
  display:flex; align-items:center; gap:8px; min-height:42px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
#drawerHours > .holiday-strip .tag{
  font-weight:900; background:rgba(255,255,255,.25); padding:2px 6px; border-radius:8px;
}


.cell.sun:not(.out):not(.today):not(.selected) .daynum{
  background:rgba(255,120,140,.22);
  border-color:rgba(255,120,140,.90);
  color:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,.12);
}
.cell.holiday:not(.out):not(.today):not(.selected) .daynum{
  background:rgba(255,209,102,.28);
  border-color:#FFD166;
  color:#153960;
  text-shadow:0 1px 0 rgba(255,255,255,.30);
  box-shadow:0 1px 2px rgba(0,0,0,.12);
}


/* Weekend & Holiday day styling (solid colors) */
.cell.sat:not(.out):not(.today):not(.selected) .daynum,
.cell.sun:not(.out):not(.today):not(.selected) .daynum{
  background:#2EA1FF;          /* weekend: solid azure */
  border-color:#FFFFFF;         /* crisp border */
  color:#FFFFFF;                /* high contrast */
  box-shadow:0 1px 2px rgba(0,0,0,.18);
}
/* Place holiday after weekend so it wins when a holiday falls on weekend */
.cell.holiday:not(.out):not(.today):not(.selected) .daynum{
  background:#FFD166;           /* holiday: solid golden */
  border-color:#B98900;         /* darker gold border */
  color:#153960;                /* readable dark text */
  box-shadow:0 1px 2px rgba(0,0,0,.18);
}


/* Day color context menu */
.context-menu{
  position:fixed; top:0; left:0; width:max-content; height:auto;
  background:rgba(22,36,56,.98); color:#fff;
  border:1px solid rgba(255,255,255,.15); border-radius:8px;
  padding:6px; box-shadow:0 6px 16px rgba(0,0,0,.32);
  z-index:9999; display:none;
}
.context-menu[aria-hidden="false"]{ display:grid; grid-template-columns: 132px auto; gap:8px; align-items:center; max-width:unset; }
.context-menu input[type="color"]{ width:22px; height:22px; padding:0; border:0; background:transparent; cursor:pointer; }
.context-menu button{ appearance:none; border:0; border-radius:6px; padding:6px 8px; font-weight:700; font-size:12px; cursor:pointer; background:rgba(255,255,255,.14); color:#fff; white-space:nowrap; }
.context-menu button:hover{ background:rgba(255,255,255,.22); }


/* Preset swatches */
.context-menu{ width:max-content; }
.context-menu .swatches{ display:flex; flex-wrap:wrap; gap:6px; max-width:200px; margin-right:6px; }
.context-menu .swatch{ width:20px; height:20px; border-radius:5px; padding:0; border:1px solid rgba(255,255,255,.6); cursor:pointer; background:transparent; }
.context-menu .swatch:focus{ outline:2px solid rgba(255,255,255,.7); outline-offset:1px; }


/* Ensure selected day always has black text for visibility */
.cell.selected .daynum{ color:#000000 !important; }


/* Context menu grid layout: swatches (left) + tools (right) */
.context-menu{ width:max-content; }
.context-menu[aria-hidden="false"]{
  display:grid; grid-template-columns: 132px auto; gap:8px; align-items:center;
  max-width:unset;
}
.context-menu .swatches{
  display:grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: 20px;
  gap:6px; width:132px;
}
.context-menu .swatch{
  width:20px; height:20px; border-radius:5px; padding:0;
  border:1px solid rgba(255,255,255,.6); cursor:pointer; background:transparent;
}
.context-menu .tools{ display:flex; align-items:center; gap:10px; }
.context-menu input[type="color"]{ width:22px; height:22px; padding:0; border:0; background:transparent; cursor:pointer; }
.context-menu button{ appearance:none; border:0; border-radius:6px; padding:6px 8px; font-weight:700; font-size:12px; cursor:pointer; background:rgba(255,255,255,.14); color:#fff; white-space:nowrap; }
.context-menu button:hover{ background:rgba(255,255,255,.22); }


    /* Multi-day selection highlight */
    .cell.range:not(.out) .daynum{
      outline:2px solid #FFFFFF;
      box-shadow:0 0 0 2px rgba(0,0,0,.25) inset;
    }
    

/* Single (plain click) selection: solid white pill */
.cell.selected-single .daynum{
  background:#FFFFFF !important;
  border-color:#FFFFFF !important;
  color:#0f2742 !important;
  font-weight:900 !important;
  box-shadow:0 1px 2px rgba(0,0,0,.25);
}
/* Multi (shift+click or drag) selection: rounded cap border */
.cell.selected-multi .daynum{
  background:transparent !important;
  border:2px solid #FFFFFF !important;
  color:#FFFFFF !important;
  border-radius:999px !important;
  font-weight:800;
  box-shadow:0 1px 2px rgba(0,0,0,.25);
}


/* === Split screen layout === */
.work{flex:1 1 auto; min-height:0; display:flex; gap:12px; padding:0 8px 8px; align-items:stretch;}
.calendar-wrap{display:flex; flex-direction:column; flex:0 0 var(--device-w); width:var(--device-w); min-width:var(--device-w); min-height:0;}
.calendar-wrap > .weekday-row{position:sticky; top:var(--header-h); z-index:var(--z-weekbar);}
.calendar-wrap > .canvas{flex:1; min-height:0; overflow:auto;}
.gantt-shell{flex:1 1 auto; min-width:0; display:flex; flex-direction:column; min-height:0; color:#fff; position:relative;}
.gantt-head{flex:0 0 auto; display:flex; align-items:center; justify-content:flex-start; gap:10px; padding:8px 10px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.14); border-radius:12px; margin:6px 0;}
.gantt-head .title{font-size:14px; font-weight:900; text-transform:uppercase; letter-spacing:.06em;}
.gantt-xhead{overflow:hidden; flex:1 1 auto; min-width:0;}
.gantt-months{height:22px;}
.gantt-monthsInner{position:relative; height:22px; display:flex;}
.gantt-monthsInner .m{flex:0 0 auto; height:100%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:800; opacity:.95; border-right:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); padding:0 4px;}
.gantt-body{flex:1 1 auto; min-height:0; display:grid; grid-template-columns: 220px 1fr; gap:8px;}
.gantt-left{overflow:auto; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:10px; position:relative;}
.gantt-tree{ position:relative;list-style:none; margin:0; padding:0;}
.gantt-tree .node{display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08); font-weight:800;}
.gantt-tree .node .caret{width:16px; text-align:center; cursor:pointer; opacity:.9;}
.gantt-tree .stage{padding-left:28px; font-weight:700; opacity:.95; height:36px; display:flex; align-items:center;}
.gantt-xbody{overflow-x:auto; overflow-y:hidden; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:10px; position:relative;}
.gantt-grid{position:relative; width: calc(var(--gcol) * var(--days)); min-height: var(--grid-h, 400px); background-image: repeating-linear-gradient(to right, rgba(255,255,255,.08) 0, rgba(255,255,255,.08) var(--gcol), rgba(255,255,255,.04) var(--gcol), rgba(255,255,255,.04) calc(var(--gcol)*2));}
.gantt-grid .rowline{position:absolute; left:0; right:0; height:36px; border-bottom:1px solid rgba(255,255,255,.08);}
.gantt-grid .bar{position:absolute; height:var(--bar-h); border-radius:8px; display:flex; align-items:center; padding:0 8px; font-size:var(--gantt-font-size); font-weight:var(--gantt-font-weight); font-family:var(--gantt-font-family); cursor:grab; box-shadow:0 2px 6px rgba(0,0,0,.3);}
.gantt-grid .bar .label{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; color: var(--gantt-font-color, inherit);}
.gantt-grid .bar .handles{margin-left:auto; display:flex; gap:4px;}
.gantt-grid .bar .h{width:8px; height:14px; background:rgba(0,0,0,.25); border-radius:2px; cursor:ew-resize;}
.gantt-grid .bar:active{cursor:grabbing;}
/* Sticky months alignment with timeline */
.gantt-xbody::-webkit-scrollbar{height:12px}


/* Localize calendar header & overlays to the left column */
.calendar-wrap > .topbar{width:100%; max-width:var(--device-w); margin:0 auto 0px auto; border-radius:0px;}
.calendar-wrap .scrim{position:absolute; inset:0; width:100%; height:100%;}
.calendar-wrap{position:relative;}
.calendar-wrap .drawer{left:0; right:auto; width:100%; max-width:var(--device-w);}
.calendar-wrap .sidepanel{left:0; right:auto; width:100%; max-width:var(--device-w);}


/* Center the year toggle perfectly under the "Calendar" title */
.topbar{ position:relative; }
.topbar .country-select{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  z-index:3;
}

/* Layoutâ€”make the controls row a flex line */
.topbar .navrow.controls{
  display:flex;
  align-items:center;
  position:relative; /* keeps the centered pill positioned within the bar */
}

/* Keep the year toggle perfectly centered and not blocking clicks on the right */
.topbar .center{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  pointer-events:none;
}
.topbar .center > *{ pointer-events:auto; }

/* Push the right group to the far edge */
.topbar .navrow.controls .right{
  margin-left:auto;           /* this is what actually pushes it right */
  display:flex;
  align-items:center;
  gap:8px;
  z-index:3;                  /* sits above the centered pill */
}

/* Country select: sit in the right group and align to the edge */
.topbar .navrow.controls .right .country-select{
  margin-left:auto; /* ensures it hugs the right even if other items appear */
}

.topbar .year-toggle { display:flex; align-items:center; gap:8px; }

/* Uniform row heights so labels and bars align */
.gantt-tree .node{height:var(--row-h); padding:0 10px; display:flex; align-items:center;}
.gantt-tree .stage{height:var(--row-h); padding-left:28px; display:flex; align-items:center;}


/* Keep controls row positioned relative for center absolute alignment */
.navrow.controls{position:relative;}


/* Month background bands behind the timeline */
.gantt-xbody{position:relative;}
.gantt-month-bg{position:absolute; inset:0 auto 0 0; height:100%; display:flex; pointer-events:none; z-index:0;}
.gantt-month-bg .m{flex:0 0 auto; height:100%;}
/* Raise grid above month background */
.gantt-grid{position:relative; z-index:1;}
/* Cursor hint for draggable header */
.gantt-xhead{cursor:grab;}
.gantt-xhead.dragging{cursor:grabbing;}


/* Task editing badge */
#taskModeBadge{display:none; align-items:center; gap:8px; font-weight:900; text-transform:uppercase; font-size:12px; background:rgba(116,251,214,.15); border:1px solid rgba(116,251,214,.5); padding:6px 10px; border-radius:999px; margin:6px 0;}
body.taskmode #taskModeBadge{display:inline-flex;}


/* Ensure center overlay doesn't block the right controls */
.navrow.controls{position:relative;}
.topbar .center{position:absolute; left:50%; transform:translateX(-50%); pointer-events:none;}
.topbar .center .year-toggle{pointer-events:auto;}
.navrow.controls .right{position:relative; z-index:3;}
/* Country select visible styling */
.country-select{appearance:none; background:rgba(255,255,255,.85); color:#111; border:1px solid rgba(0,0,0,.2); border-radius:10px; padding:6px 10px; font-weight:800; min-width:56px; width:auto;}
.country-select:focus{outline:2px solid rgba(255,255,255,.6); outline-offset:2px;}
.country-select:hover{background:rgba(255,255,255,1)}
/* Compact country select to short code */
.country-select option { font-weight:800; }

/* Gantt context menu */
.gctx {
  position: fixed; z-index: 9999;
  display: none; min-width: 140px;
  background: rgba(18,18,18,.95); color: #fff;
  border: 1px solid rgba(255,255,255,.2); border-radius: 10px;
  padding: 6px; box-shadow: 0 8px 30px rgba(0,0,0,.45);
}
.gctx .item { padding: 8px 10px; border-radius: 8px; font-weight: 800; cursor: pointer; }
.gctx .item:hover { background: rgba(255,255,255,.1); }

#ganttTree .stage.drag-over{outline:2px dashed var(--accent,#2EA1FF); outline-offset:-2px;}



/* Gantt: align month header with grid columns & bar rows */
.gantt-xhead{ padding-left:1px; }                /* compensate xbody border-left */
.gantt-months{ height:var(--row-h); position:relative; }
.gantt-monthsInner{ height:var(--row-h); }
.gantt-monthsInner .m{ height:var(--row-h); display:flex; align-items:center; }
.gantt-grid .rowline{ height:var(--row-h); }             /* ensure row lines match */


/* Dedicated right-side drawer confined to Gantt panel */
.gantt-shell .drawer.right{ left:auto; right:0; width:min(520px, 48vw); max-width:520px; }
/* Keep calendar drawer confined to the left panel */
.calendar-wrap .drawer{ left:0; right:auto; width:100%; max-width:var(--device-w); }


/* Inline editable styling */
#ganttTree .label.editable { outline: none; border-radius: 6px; padding: 0 4px; }
#ganttTree .label.editable:focus { background: rgba(255,255,255,0.08); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25); }


/* Gantt style controls */
.gantt-style {
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
}
.gantt-style details {
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 10px;
  padding: 6px 8px;
}
.gantt-style summary{ cursor:pointer; font-weight:900; }
.gantt-style .panel{
  display:grid; grid-template-columns: repeat(2, auto); gap:8px 10px; padding-top:6px; align-items:center;
}
.gantt-style label{ font-size:12px; opacity:.9; }
.gantt-style input[type="range"],
.gantt-style input[type="number"],
.gantt-style select,
.gantt-style input[type="color"]{
  background: rgba(255,255,255,.12); color:#fff; border:0; border-radius:8px; padding:6px 8px;
}
.gantt-style .zoom-buttons button{
  appearance:none;border:0;border-radius:8px;padding:6px 8px;background:rgba(255,255,255,.16);color:#fff;cursor:pointer;font-weight:900;
}

/* Resize handle on the right edge of Gantt panel */
#ganttResize{
  position:absolute; top:0; right:-5px; bottom:0; width:10px;
  cursor: ew-resize; z-index: 1500;
  background: linear-gradient(to right, transparent, rgba(255,255,255,.08), transparent);
  border-right:1px solid rgba(255,255,255,.12);
}
#ganttResize:hover{ background: linear-gradient(to right, transparent, rgba(255,255,255,.16), transparent); }


/* Apply font variables across Gantt */
#ganttTree, #ganttTree .label, .gantt-tree .node, .gantt-tree .stage, .gantt-grid, .gantt-grid .bar, .gantt-grid .bar .label {
  font-family: var(--gantt-font-family);
  font-size: var(--gantt-font-size);
  color: var(--gantt-font-color, inherit);
}

/* Apply font to month headers as well */
.gantt-xhead, .gantt-months, .gantt-monthsInner, .gantt-monthsInner .m, .gantt-monthsInner .m .label{
  font-family: var(--gantt-font-family);
  font-size: var(--gantt-font-size);
  color: var(--gantt-font-color, #fff);
}

/* Left-panel resize handle */
#ganttTreeResize{
  position:absolute; top:0; bottom:0; left:calc(100% - 3px); width:6px;
  cursor: ew-resize; z-index: 1500;
  background: linear-gradient(to right, transparent, rgba(255,255,255,.08), transparent);
}
/* Small handle in xhead (top-right) sharing same behavior as main right handle */
</style>
</head>
<body>
  <main class="app" aria-label="Calendar application">
    
    
    <div class="work">
      <div class="calendar-wrap">
        <header class="topbar">
      <nav class="navrow">
        <button class="btn icon" id="menuBtn" aria-label="Menu">â‰¡</button>
        <div class="title">Calendar</div>
        <button class="btn icon" id="searchBtn" aria-label="Search">ðŸ”Ž</button>
      </nav>
      <nav class="navrow controls">
        <div class="left"><button class="btn" id="todayBtn" title="Jump to today">Today</button></div>
        <div class="center">
          <div class="year-toggle" aria-label="Calendar year">
            <button class="btn icon" id="yearPrev" aria-label="Previous year">â€¹</button>
            <button class="btn year-pill" id="yearLabel" aria-label="Selected year">0000</button>
            <button class="btn icon" id="yearNext" aria-label="Next year">â€º</button>
          </div>
        </div>
        <div class="right">
  <select id="countrySelect" class="country-select" aria-label="Country">
    
    <option value="SG">SG</option>
    <option value="MY">MY</option>
    <option value="CN">CN</option>
    <option value="TW">TW</option>
    <option value="JP">JP</option>
    <option value="US">US</option>

  </select>
</div>
      </nav>
    </header>
<div class="weekday-row"><div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div></div>
        <section class="canvas" id="canvas" role="region" aria-live="polite"></section>
      <aside class="drawer" id="drawer" aria-hidden="true">
      <div class="drawer-header">
        <div class="drawer-title" id="drawerTitle">Events</div>
        <span id="taskModeBadge" style="display:none;margin-left:10px;padding:4px 10px;border-radius:999px;border:1px solid rgba(116,251,214,.6);background:rgba(116,251,214,.16);font-weight:900;text-transform:uppercase;font-size:12px">Gantt Task</span>
        <button class="drawer-close" id="drawerClose">Close</button>
      </div>
      <div class="drawer-body">
        <div class="edit-panel" id="editPanel">
  <button id="editPanelToggle" aria-expanded="false" aria-controls="eventForm">
    Show edit panel â–¼
  </button>
</div>
<form class="event-form collapsed" id="eventForm" hidden>
          <input type="text" id="eventTitle" class="title-field" placeholder="Add an event" required />
          <input type="date" id="eventStartDate" class="date-start" />
          <input type="date" id="eventEndDate" class="date-end" />
          <input type="time" id="eventStart" class="time-start" value="09:00" />
          <input type="time" id="eventEnd" class="time-end" value="10:00" />
          <input type="text" id="eventLocation" class="location-field" placeholder="Location" />
          <select id="taskProject" class="stage-field">
            <option value="">-- Project (optional) --</option>
            <option>Project A</option>
            <option>Project B</option>
            <option>Project C</option>
          </select>
          <select id="taskStage" class="stage-field">
            <option value="">-- Stage (optional) --</option>
            <option>Project Pitch</option>
            <option>Research</option>
            <option>Lead Generation</option>
            <option>Pre-Production</option>
            <option>Production</option>
            <option>Post-Production</option>
            <option>Social Media Distribution</option>
            <option>Data Analysis</option>
          </select>
          <label class="task-flag" style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="taskFlag" /> <span>Task (sync with Gantt)</span>
          </label>

          <input type="color" id="eventColor" class="color-field" value="#74FBD6" title="Color" />
          <button class="submit" id="submitBtn" type="submit">Add</button>
        </form>
        <div class="day-hours" id="drawerHours"></div>
      </div>
    </aside>
</div>
<div class="scrim" id="scrim"></div>

<aside class="gantt-shell" id="gantt">
  <div class="gantt-head">
    <div class="title">Gantt</div>
    <div class="gantt-xhead"><div class="gantt-months"><div class="gantt-monthsInner" id="ganttMonths"></div><div id="ganttMonthsResize" title="Drag to resize Gantt"></div></div></div>
<div class="gantt-style">
<details id="ganttStyleCtl">
<summary>Style</summary>
<div class="panel">
<label for="zoomSlider">Zoom (day width)</label>
<div class="zoom-buttons" style="display:flex; gap:6px; align-items:center;">
  <button type="button" id="zoomOutBtn">âˆ’</button>
  <input type="range" id="zoomSlider" min="12" max="60" step="1" style="width:140px">
  <button type="button" id="zoomInBtn">+</button>
</div>

<label for="rowHeight">Row height</label>
<input type="range" id="rowHeight" min="24" max="60" step="2" value="36">
<label for="fontSize">Font size</label>
<input type="number" id="fontSize" min="10" max="24" value="12">

<label for="fontFamily">Font family</label>
<select id="fontFamily">
  <option value="Source Sans Pro, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">Source Sans Pro</option>
  <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">System UI</option>
  <option value="Georgia, 'Times New Roman', serif">Serif</option>
  <option value="'Courier New', Courier, monospace">Monospace</option>
</select>
<label for="fontColor">Font color</label>
<input type="color" id="fontColor" value="#FFFFFF">
</div>
</details>
</div>

  </div>
  <div class="gantt-body">
    <div class="gantt-left">
      <ul class="gantt-tree" id="ganttTree"></ul>
    </div>
    <div class="gantt-xbody" id="ganttXBody">
      <div class="gantt-month-bg" id="ganttMonthBG"></div>
      <div class="gantt-grid" id="ganttGrid"></div>
    </div>
  </div>
      
        <!-- Gantt Task Drawer -->
        <aside class="drawer right" id="taskDrawer" aria-hidden="true">
          <div class="drawer-header">
            <div class="drawer-title" id="taskDrawerTitle">Task</div>
            <button class="drawer-close" id="taskDrawerClose" type="button">Close</button>
          </div>
          <div class="drawer-body">
            <form class="event-form" id="taskForm">
              <input type="text" id="tTitle" class="title-field" placeholder="Task title" required />
              <input type="date" id="tStartDate" class="date-start" />
              <input type="date" id="tEndDate" class="date-end" />
              <input type="time" id="tStartTime" class="time-start" value="09:00" />
              <input type="time" id="tEndTime" class="time-end" value="10:00" />
              <input type="text" id="tLocation" class="location-field" placeholder="Location (optional)" />
              <select id="tProject" class="stage-field">
                <option value="">-- Project --</option>
                <option>Project A</option>
                <option>Project B</option>
                <option>Project C</option>
              </select>
              <select id="tStage" class="stage-field">
                <option value="">-- Stage --</option>
                <option>Project Pitch</option>
                <option>Research</option>
                <option>Lead Generation</option>
                <option>Pre-Production</option>
                <option>Production</option>
                <option>Post-Production</option>
                <option>Social Media Distribution</option>
                <option>Data Analysis</option>
              </select>
              <input type="color" id="tColor" class="color-field" value="#74FBD6" title="Color" />
              <div class="submit-row"><button class="submit" id="tSubmitBtn" type="submit">Save Task</button>
<button class="submit danger" id="tDeleteBtn" type="button">Delete Task</button></div>
            </form>
          </div>
        </aside>
<div id="ganttTreeResize" title="Drag to resize tree"></div>
<div id="ganttResize" title="Drag to resize Gantt"></div>
</aside>
    </div>
    

    

    <aside class="side" id="menuPanel" aria-hidden="true">
      <header>
        <h3>Data & Sync</h3>
        <button class="btn icon" id="menuClose" aria-label="Close">Ã—</button>
      </header>
      <div class="content">
        <div class="group">
          <h4>Export</h4>
          <div class="row">
            <button class="btn" id="exportBtn">Export JSON</button>
          </div>
          <div class="note">Downloads a .json backup of your events.</div>
        </div>
        <div class="group">
          <h4>Import</h4>
          <div class="row">
            <button class="btn" id="importReplaceBtn">Import (replace)</button>
            <button class="btn" id="importMergeBtn">Import (merge)</button>
            <input type="file" id="importFile" accept="application/json" hidden />
          </div>
          <div class="note">Replace overwrites everything. Merge keeps existing events and adds new ones.</div>
        </div>
      </div>
    </aside>

    <div class="search" id="searchOverlay" aria-hidden="true">
      <div class="sheet">
        <input class="q" id="searchInput" type="text" placeholder="Search events or type a dateâ€¦ (Ctrl/Cmd+K)" />
        <ul id="searchList"></ul>
      </div>
    </div>

    
  </main>

<script>
if (typeof root === "undefined") { var root = document.documentElement; }

/* --- Confined scrollIntoView: only scroll the nearest scrollable ancestor (never the parent page) --- */
(function(){
  var nativeFocus = HTMLElement.prototype.focus;
  function getScrollParent(el){
    var p = el && el.parentElement;
    while(p && p !== document.body){
      var cs = getComputedStyle(p);
      if(/auto|scroll/i.test(cs.overflowY) || /auto|scroll/i.test(cs.overflow)) return p;
      p = p.parentElement;
    }
    return null;
  }
  function smoothScrollTo(el, to, duration){
    try{
      var start = el.scrollTop, change = to - start;
      if (duration <= 0 || Math.abs(change) < 1){ el.scrollTop = to; return; }
      var startTime = performance.now();
      function step(now){
        var t = Math.min(1, (now - startTime) / duration);
        var eased = t < 0.5 ? 2*t*t : -1 + (4 - 2*t) * t;
        el.scrollTop = Math.round(start + change * eased);
        if (t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }catch(e){ el.scrollTop = to; }
  }
  Element.prototype.scrollIntoView = function(options){
    try{
      var sp = getScrollParent(this);
      if(!sp) return; // no internal scroller -> do nothing (prevents page scroll)
      var spRect = sp.getBoundingClientRect();
      var elRect = this.getBoundingClientRect();
      var current = sp.scrollTop;
      var elemTop = current + (elRect.top - spRect.top);
      var elemBottom = current + (elRect.bottom - spRect.top);
      var target = current;
      var behavior = 'auto', block = 'nearest';
      if (typeof options === 'boolean'){ block = options ? 'start' : 'nearest'; }
      else if (options && typeof options === 'object'){ behavior = options.behavior || 'auto'; block = options.block || 'nearest'; }
      if (block === 'start') target = elemTop;
      else if (block === 'center') target = Math.round(elemTop - (spRect.height - (elRect.height||0))/2);
      else if (block === 'end') target = Math.max(0, elemBottom - spRect.height);
      else {
        if (elRect.top < spRect.top) target = elemTop;
        else if (elRect.bottom > spRect.bottom) target = Math.max(0, elemBottom - spRect.height);
      }
      target = Math.max(0, target);
      if (behavior === 'smooth') smoothScrollTo(sp, target, 280);
      else sp.scrollTop = target;
    }catch(e){ /* swallow to avoid affecting host */ }
  };
  // Prevent focus from scrolling outer page
  HTMLElement.prototype.focus = function(opts){
    try{ nativeFocus.call(this, Object.assign({}, opts||{}, {preventScroll:true})); }
    catch(e){ nativeFocus.call(this); }
  };

  // --- Left panel resize
  const leftHandle = document.getElementById('ganttTreeResize');
  if (leftHandle){
    let sx=0, sw=0, dragging=false;
    const minL = 160, maxL = 520;
    function numberFromVar(val, fallback){ const n=parseFloat(val||''); return Number.isFinite(n)?n:fallback; }
    leftHandle.addEventListener('mousedown', (e)=>{
      e.preventDefault(); dragging=true; sx=e.clientX;
      const used = getComputedStyle(root).getPropertyValue('--gantt-left-w').trim();
      sw = numberFromVar(used, 260);
      document.body.classList.add('noselect');
    });
    window.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      const dx = e.clientX - sx;
      const w = Math.max(minL, Math.min(maxL, sw + dx));
      root.style.setProperty('--gantt-left-w', w+'px');
      // also move the handle itself by CSS left using var (handled by CSS calc)
      window.persist && window.persist();
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.classList.remove('noselect'); });
  }
    xHandle.addEventListener('mousedown', (e)=>{
      e.preventDefault(); dragging=true; sx = e.clientX;
      const used = getComputedStyle(root).getPropertyValue('--gantt-w').trim();
      sw = numberFromVar(used, (document.querySelector('.gantt-shell')?.clientWidth || 860));
      document.body.classList.add('noselect');
    });
    window.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      const dx = e.clientX - sx;
      const w = Math.max(minW, Math.min(maxW, sw + dx));
      root.style.setProperty('--gantt-w', w+'px'); window.persist && window.persist();
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.classList.remove('noselect'); });
  });


(function(){
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const dows = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
  const tones = [
    ['#56D7C7','#49A7D2'],['#E5A4E3','#C26BD4'],['#7FE3A4','#4CC5A2'],['#F1E184','#E2B76E'],
    ['#FFD36A','#F7A062'],['#FF9E7A','#F26F8C'],['#F478B9','#D25FAE'],['#C07AF1','#875DD1'],
    ['#7A7FEF','#4E67C8'],['#F8D86E','#F08E6C'],['#EC6F8E','#D84C9E'],['#4660B9','#2A85A4']
  ];

  const STORAGE_KEY = 'yearStreamEventsV1';
  const canvas = document.getElementById('canvas');
  const drawer = document.getElementById('drawer');
  const drawerTitle = document.getElementById('drawerTitle');
  const drawerHours = document.getElementById('drawerHours');
  const form = document.getElementById('eventForm');

let isEditPanelOpen = false;
function setEditPanel(open){
  isEditPanelOpen = !!open;
  const formEl = document.getElementById('eventForm');
  if (formEl){
    formEl.classList.toggle('collapsed', !isEditPanelOpen);
    try{ formEl.toggleAttribute('hidden', !isEditPanelOpen); }catch(e){}
  }
  const toggleBtn = document.getElementById('editPanelToggle');
  if (toggleBtn){
    toggleBtn.setAttribute('aria-expanded', String(isEditPanelOpen));
    toggleBtn.textContent = isEditPanelOpen ? 'Hide edit panel â–²' : 'Show edit panel â–¼';
  }
}
const editPanel = document.getElementById('editPanel');
const editPanelToggle = document.getElementById('editPanelToggle');

document.addEventListener('DOMContentLoaded', ()=>{
  const toggleBtn = document.getElementById('editPanelToggle');
  if (toggleBtn){
    toggleBtn.addEventListener('click', ()=> setEditPanel(!isEditPanelOpen));
    toggleBtn.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); setEditPanel(!isEditPanelOpen); }
    });
  }
});


  const titleInput = document.getElementById('eventTitle');
  const startDateInput = document.getElementById('eventStartDate');
  const endDateInput = document.getElementById('eventEndDate');
  const startInput = document.getElementById('eventStart');
  const endInput = document.getElementById('eventEnd');
  const locationInput = document.getElementById('eventLocation');
  const colorInput = document.getElementById('eventColor');
// === Gantt model & sync ===

  // Toggle task mode badge visibility
  (function(){
    const badge = document.getElementById('taskModeBadge');
    const mo = new MutationObserver(()=>{
      if(!badge) return;
      const on = document.body.classList.contains('taskmode');
      badge.style.display = on ? 'inline-flex' : 'none';
    });
    mo.observe(document.body, { attributes:true, attributeFilter:['class'] });
  })();

  const STAGES = ["Project Pitch","Research","Lead Generation","Pre-Production","Production","Post-Production","Social Media Distribution","Data Analysis"];
function loadStageConfig(){ try{ const a = JSON.parse(localStorage.getItem('cc_stage_list')); if(Array.isArray(a) && a.length){ STAGES.splice(0, STAGES.length, ...a); } }catch(_){} }
function saveStageConfig(){ try{ localStorage.setItem('cc_stage_list', JSON.stringify(STAGES)); }catch(_){} }
window.addEventListener('load', loadStageConfig);
  const STAGE_COLORS = {
    "Project Pitch":"#74FBD6","Research":"#A88BEB","Lead Generation":"#2EA1FF","Pre-Production":"#FFD166",
    "Production":"#FF7A59","Post-Production":"#FF9EC4","Social Media Distribution":"#7CF29C","Data Analysis":"#6C63FF"
  };

  const MONTH_COLORS = ['#56D7C7', '#E5A4E3', '#7FE3A4', '#F1E184', '#FFD36A', '#FF9E7A', '#F478B9', '#C07AF1', '#7A7FEF', '#F8D86E', '#EC6F8E', '#4660B9'];
  const PROJECTS = ["Project A","Project B","Project C"];
  let projectState = JSON.parse(localStorage.getItem('GANTT_PROJECT_STATE')||'{}'); // {Project A: {open:true}}
  function saveProjectState(){ localStorage.setItem('GANTT_PROJECT_STATE', JSON.stringify(projectState)); }

  const TASKS_KEY = 'yearStreamTasksV1';
  function loadTasks(){ try{ return JSON.parse(localStorage.getItem(TASKS_KEY))||{} }catch(e){ return {} } }
  function saveTasks(){ localStorage.setItem(TASKS_KEY, JSON.stringify(tasks)); }
  let tasks = loadTasks(); // {id:{id,title,color,project,stage,start,end,startTime,endTime,location}}


// === Separate Gantt Task Drawer (right) ===
const taskDrawer = document.getElementById('taskDrawer');
const taskDrawerTitle = document.getElementById('taskDrawerTitle');
const taskForm = document.getElementById('taskForm');
const tTitle = document.getElementById('tTitle');
const tStartDate = document.getElementById('tStartDate');
const tEndDate = document.getElementById('tEndDate');
const tStartTime = document.getElementById('tStartTime');
const tEndTime = document.getElementById('tEndTime');
const tLocation = document.getElementById('tLocation');
const tProject = document.getElementById('tProject');
const tStage = document.getElementById('tStage');
const tColor = document.getElementById('tColor');
let ganttEditingId = null;

function openTaskDrawer(task){
  ganttEditingId = task ? task.id : null;
  const title = task ? `Task Â· ${(task.project||'')}${(task.project && task.stage ? ' â€” ' : '')}${task.stage||''}` : 'New Task';
  if(taskDrawerTitle) taskDrawerTitle.textContent = title;

  tTitle.value = (task && task.title) || '';
  tStartDate.value = (task && task.start) || (state.drawerDate ? toYMD(state.drawerDate) : toYMD(new Date(state.year,0,1)));
  tEndDate.value = (task && task.end) || tStartDate.value;
  tStartTime.value = (task && task.startTime) || '09:00';
  tEndTime.value = (task && task.endTime) || '10:00';
  tLocation.value = (task && task.location) || '';
  tProject.value = (task && task.project) || '';
  tStage.value = (task && task.stage) || '';
  tColor.value = (task && task.color) || '#74FBD6';

  taskDrawer.classList.add('open');
  taskDrawer.setAttribute('aria-hidden','false');
}
function closeTaskDrawer(){
  ganttEditingId = null;
  if(taskDrawer){ taskDrawer.classList.remove('open'); taskDrawer.setAttribute('aria-hidden','true'); }
}
const taskDrawerClose = document.getElementById('taskDrawerClose');
if(taskDrawerClose) taskDrawerClose.addEventListener('click', closeTaskDrawer);
const tDeleteBtn = document.getElementById('tDeleteBtn');
function toggleTaskDeleteBtn(){
  if (!tDeleteBtn) return;
  tDeleteBtn.style.display = (ganttEditingId && tasks[ganttEditingId]) ? 'inline-block' : 'none';
}
if (tDeleteBtn){
  tDeleteBtn.addEventListener('click', ()=>{
    if (!ganttEditingId || !tasks[ganttEditingId]) return;
    if (!confirm('Delete this task and all mirrored calendar events?')) return;
    const id = ganttEditingId;
    delete tasks[id]; saveTasks();
    removeTaskEventInstances(id); saveEvents();
    try{ if (typeof renderGantt === 'function') renderGantt(); try{ refreshTaskPickers(); }catch(_){ } }catch(_){}
    if (state.drawerDate) renderDayHours(state.drawerDate);
    closeTaskDrawer();
  });
}

if(taskForm) taskForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const base = {
    title: (tTitle.value||'').trim(),
    project: tProject.value,
    stage: tStage.value,
    start: tStartDate.value, end: tEndDate.value,
    startTime: tStartTime.value, endTime: tEndTime.value,
    color: tColor.value, location: tLocation.value
  };
  if(!base.title || !base.project || !base.stage || !base.start || !base.end){
    alert('Please fill Title, Project, Stage, Start & End.'); return;
  }
  if(ganttEditingId && tasks[ganttEditingId]){
    const tt = tasks[ganttEditingId];
    Object.assign(tt, base);
    tasks[tt.id]=tt;
    saveTasks();
    syncTaskToEvents(tt);
  } else {
    const id = 't'+Math.random().toString(36).slice(2,8)+Date.now().toString(36);
    const newT = Object.assign({id}, base);
    tasks[id] = newT;
    saveTasks();
    syncTaskToEvents(newT);
  }
  renderGantt(); try{ refreshTaskPickers(); }catch(_){ }
  closeTaskDrawer();
});


// --- Gantt task helpers ---
function datesOverlap(aStart, aEnd, bStart, bEnd){
  const as = parseYMD(aStart), ae = parseYMD(aEnd);
  const bs = parseYMD(bStart), be = parseYMD(bEnd);
  return !(ae < bs || as > be);
}
function hasStageDayConflict(candidate, skipId){
  for (const t of Object.values(tasks)){
    if (skipId && t.id === skipId) continue;
    if (t.project === candidate.project && t.stage === candidate.stage){
      if (datesOverlap(candidate.start, candidate.end, t.start, t.end)) return true;
    }
  }
  return false;
}


  // Utility
  function dayOfYear(d){ const start = new Date(d.getFullYear(),0,1); return Math.floor((d - start)/86400000)+1; }
  function daysInYear(y){ return ((y%4===0 && y%100!==0) || (y%400===0)) ? 366 : 365; }

  function ensureProjectState(){ PROJECTS.forEach(p=>{ if(!projectState[p]) projectState[p]={open:true}; }); saveProjectState(); }
  ensureProjectState();

  // Sync task <-> calendar events
  function removeTaskEventInstances(taskId){
    const touched = new Set();
    for (const [k, list] of Object.entries(events)) {
      const keep = list.filter(e => e.taskId !== taskId);
      if (keep.length !== list.length) { // something changed
        touched.add(k);
      }
      if (keep.length) events[k] = keep; else delete events[k];
    }
    // refresh day markers for affected keys
    touched.forEach(k => updateMarkerForKey(k));
  }
  
  function syncTaskToEvents(task){
  if (!task || !task.start || !task.end) return;

  // 1) Remove previous mirrored events for this task
  removeTaskEventInstances(task.id);

  // 2) Recreate events for each day in the task's range
  const s = parseYMD(task.start), e = parseYMD(task.end);
  for (let d = new Date(s); d <= e; d = addDays(d, 1)) {
    const k = keyOf(d);
    if (!events[k]) events[k] = [];
    events[k].push({
      id: uid(),
      title: task.title,
      start: task.startTime || '09:00',
      end:   task.endTime   || '10:00',
      color: task.color || (STAGE_COLORS && STAGE_COLORS[task.stage]) || '#74FBD6',
      location: task.location || '',
      taskId: task.id
    });
    updateMarkerForKey(k);
  }

  // 3) Persist + refresh UIs
  saveEvents();
  if (state.drawerDate) renderDayHours(state.drawerDate);
  try { if (typeof renderGantt === 'function') renderGantt(); try{ refreshTaskPickers(); }catch(_){ } } catch (_) {}
}

  // Gantt rendering with projects/folders and stage rows
  
  // Gantt bar context menu (Delete) [lazy-bind + robust handlers]
let ganttCtx = null;
let ctxTaskId = null;
let ctxShownAt = 0;
function ensureGanttCtx(){ return ganttCtx || (ganttCtx = document.getElementById('ganttCtx')); }

function showCtx(x, y, taskId){
  ctxShownAt = Date.now();
  const el = ensureGanttCtx();
  if (!el) return;
  ctxTaskId = taskId;
  const vw = window.innerWidth, vh = window.innerHeight;
  const w = 160, h = 44;
  el.style.display = 'block';
  el.style.left = Math.min(x, vw - w - 8) + 'px';
  el.style.top  = Math.min(y, vh - h - 8) + 'px';
}

window.addEventListener('load', () => {
  const el = ensureGanttCtx();
  if (!el) return;
  el.addEventListener('click', (e) => {
    const act = e.target.closest('.item')?.dataset?.action;
    if (act === 'delete' && ctxTaskId && tasks[ctxTaskId]) {
      delete tasks[ctxTaskId]; saveTasks();
      removeTaskEventInstances(ctxTaskId); saveEvents();
      try{ if (typeof renderGantt === 'function') renderGantt(); try{ refreshTaskPickers(); }catch(_){ } }catch(_){}
      if (state.drawerDate) renderDayHours(state.drawerDate);
    }
    el.style.display = 'none';
    ctxTaskId = null;
  });
  
// --- Stage context menu + actions ---
let stageCtx = null, ctxStageIndex = null;
function ensureStageCtx(){ return stageCtx || (stageCtx = document.getElementById('stageCtx')); }
function showStageCtx(x, y, idx){
  const el = ensureStageCtx(); if(!el) return;
  ctxStageIndex = idx;
  const vw = window.innerWidth, vh = window.innerHeight;
  const w = 200, h = 120;
  el.style.display='block';
  el.style.left = Math.min(x, vw - w - 8) + 'px';
  el.style.top  = Math.min(y, vh - h - 8) + 'px';
}
(function(){ 
  const stageEl = ensureStageCtx(); if(!stageEl) return;
  stageEl.addEventListener('click', (e)=>{
    const act = e.target.closest('.item')?.dataset?.action;
    const idx = ctxStageIndex;
    stageEl.style.display='none'; ctxStageIndex = null;
    if (act === 'create'){
      const name = prompt('New stage name:');
      if (name && !STAGES.includes(name)){
        STAGES.push(name);
        saveStageConfig(); try{ renderGantt(); try{ refreshTaskPickers(); }catch(_){ } }catch(_){}
      }
      return;
    }
    if (typeof idx !== 'number' || idx < 0 || idx >= STAGES.length) return;
    if (act === 'rename'){
      const old = STAGES[idx];
      const name = prompt('Rename stage:', old);
      if (name && name !== old){
        for(const t of Object.values(tasks)){ if (t.stage === old) t.stage = name; }
        STAGES[idx] = name; saveTasks(); saveStageConfig();
        try{ renderGantt(); try{ refreshTaskPickers(); }catch(_){ } }catch(_){}
        if (state.drawerDate) renderDayHours(state.drawerDate);
      }
    } else if (act === 'delete'){
      const name = STAGES[idx];
      if (confirm('Delete stage "" + name + ""? This will also delete all tasks in this stage.')){
        const delIds = Object.keys(tasks).filter(id => tasks[id].stage === name);
        for(const id of delIds){ delete tasks[id]; }
        saveTasks();
        try{ delIds.forEach(id => removeTaskEventInstances(id)); }catch(_){}
        saveEvents();
        STAGES.splice(idx,1);
        saveStageConfig();
        try{ renderGantt(); try{ refreshTaskPickers(); }catch(_){ } }catch(_){}
        if (state.drawerDate) renderDayHours(state.drawerDate);
      }
    }
  });

  document.addEventListener('mousedown', (e)=>{ if (!stageEl.contains(e.target)) { stageEl.style.display='none'; ctxStageIndex = null; } });
  document.addEventListener('mousedown', (e)=>{ if (!el.contains(e.target)) { el.style.display='none'; ctxStageIndex = null; } });
// click outside to hide (grace period prevents immediate close after open)
  document.addEventListener('mousedown', (e) => { if (el.contains(e.target)) return; el.style.display = 'none'; ctxTaskId = null; });
  // Esc to close
  document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Escape'){ el.style.display = 'none'; ctxTaskId = null; }
  });

});
});


// --- Inline edit helpers (global) ---
function renameProject(oldName, newName){
  if (!newName || oldName === newName) return false;
  if (Array.isArray(PROJECTS) && PROJECTS.includes(newName)) return false;
  const i = Array.isArray(PROJECTS) ? PROJECTS.indexOf(oldName) : -1;
  if (i < 0) return false;
  PROJECTS[i] = newName;

  // migrate tasks
  try { for (const t of Object.values(tasks)) if (t.project === oldName) t.project = newName; } catch(_){}

  // migrate projectState if present
  try {
    if (typeof projectState !== 'undefined' && projectState && Object.prototype.hasOwnProperty.call(projectState, oldName)) {
      projectState[newName] = projectState[oldName];
      delete projectState[oldName];
      if (typeof saveProjectState === 'function') saveProjectState();
    }
  } catch(_){}

  if (typeof saveProjectConfig === 'function') saveProjectConfig();
  if (typeof saveTasks === 'function') saveTasks();
  try { if (typeof refreshTaskPickers === 'function') refreshTaskPickers(); } catch(_){}
  try { if (typeof renderGantt === 'function') renderGantt(); } catch(_){}
  try { if (state && state.drawerDate) renderDayHours(state.drawerDate); } catch(_){}
  return true;
}

function renameStage(oldName, newName){
  if (!newName || oldName === newName) return false;
  if (Array.isArray(STAGES) && STAGES.includes(newName)) return false;
  const i = Array.isArray(STAGES) ? STAGES.indexOf(oldName) : -1;
  if (i < 0) return false;
  STAGES[i] = newName;

  // migrate tasks
  try { for (const t of Object.values(tasks)) if (t.stage === oldName) t.stage = newName; } catch(_){}

  if (typeof saveStageConfig === 'function') saveStageConfig();
  if (typeof saveTasks === 'function') saveTasks();
  try { if (typeof refreshTaskPickers === 'function') refreshTaskPickers(); } catch(_){}
  try { if (typeof renderGantt === 'function') renderGantt(); } catch(_){}
  try { if (state && state.drawerDate) renderDayHours(state.drawerDate); } catch(_){}
  return true;
}

// Expose in case any handlers reference window.*
window.renameProject = renameProject;
window.renameStage   = renameStage;

// Minimal picker sync if you don't already have one
if (typeof refreshTaskPickers !== 'function') {
  function refreshTaskPickers(){
    try {
      const projSels = [document.getElementById('taskProject'), document.getElementById('tProject')];
      projSels.forEach(sel=>{
        if(!sel || !Array.isArray(PROJECTS)) return;
        const v = sel.value || "";
        const header = sel.querySelector('option[value=""]') ? sel.querySelector('option[value=""]').outerHTML : '<option value="">-- Project (optional) --</option>';
        sel.innerHTML = header + PROJECTS.map(p=>`<option>${p}</option>`).join('');
        if (PROJECTS.includes(v)) sel.value = v; else if (v==="") sel.value = "";
      });
      const stageSels = [document.getElementById('taskStage'), document.getElementById('tStage')];
      stageSels.forEach(sel=>{
        if(!sel || !Array.isArray(STAGES)) return;
        const v = sel.value || "";
        const header = sel.querySelector('option[value=""]') ? sel.querySelector('option[value=""]').outerHTML : '<option value="">-- Stage (optional) --</option>';
        sel.innerHTML = header + STAGES.map(s=>`<option>${s}</option>`).join('');
        if (STAGES.includes(v)) sel.value = v; else if (v==="") sel.value = "";
      });
    } catch(_){}
  }
}

function renderGantt(){

    const colw = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--gcol')) || 20;
    const days = daysInYear(state.year);
    const grid = document.getElementById('ganttGrid');
    const monthsRow = document.getElementById('ganttMonths');
    const xbody = document.getElementById('ganttXBody');
    const tree = document.getElementById('ganttTree');
    if(!grid || !monthsRow || !xbody || !tree) return;

    // Months header widths
    monthsRow.innerHTML='';
    const monthBG = document.getElementById('ganttMonthBG'); if(monthBG){ monthBG.innerHTML=''; }
    for(let m=0;m<12;m++){
      const first = new Date(state.year,m,1);
      const next  = new Date(state.year,m+1,1);
      const len = Math.round((next-first)/86400000);
      const w = (len*colw)+'px';
      const span = document.createElement('div'); span.className='m'; span.style.width = w; span.textContent = months[m].slice(0,3).toUpperCase();
      // header tint
      span.style.background = MONTH_COLORS[m] + '33';
      monthsRow.appendChild(span);
      // body band tint
      if(monthBG){
        const band = document.createElement('div'); band.className='m'; band.style.width = w;
        band.style.background = MONTH_COLORS[m] + '22';
        monthBG.appendChild(band);
      }
    }
    monthsRow.style.width = (days*colw)+'px';

    // Build tree & row map
    tree.innerHTML='';
    const rows = []; // rows as sequence of {type:'proj'|'stage', project, stage?}
    PROJECTS.forEach(proj=>{
      // project header row
      const pNode = document.createElement('li'); pNode.className='node project';
      const caret = document.createElement('span'); caret.className='caret'; caret.textContent = projectState[proj]?.open ? 'â–¾' : 'â–¸';
      const label = document.createElement('span'); label.className='label editable'; label.contentEditable='true'; label.dataset.type='project'; label.dataset.old = proj; label.textContent = proj;
      label.className = 'label editable';
      label.contentEditable = 'true';
      label.dataset.type = 'project';
      label.dataset.old  = proj;
      label.textContent  = proj;
      caret.addEventListener('click', ()=>{ projectState[proj].open = !projectState[proj].open; saveProjectState(); renderGantt(); try{ refreshTaskPickers(); }catch(_){ } });
      pNode.appendChild(caret); pNode.appendChild(label); tree.appendChild(pNode);
      rows.push({type:'proj', project:proj});
      if(projectState[proj]?.open){
        
  STAGES.forEach((st,i)=>{
    const stNode = document.createElement('li');
    stNode.className = 'stage';
    const stLabel = document.createElement('span');
stLabel.className = 'label editable';
stLabel.contentEditable = 'true';
stLabel.dataset.type = 'stage';
stLabel.dataset.old = st;
stLabel.textContent = st;
stNode.appendChild(stLabel);
  stNode.dataset.index = i;
  // right-click: stage context menu
  stNode.addEventListener('contextmenu', (e)=>{
    e.preventDefault(); e.stopPropagation();
    if (typeof showStageCtx === 'function') showStageCtx(e.clientX, e.clientY, i);
  });
  // drag reorder
  stNode.draggable = true;
  stNode.addEventListener('dragstart', (e)=>{
    try{ e.dataTransfer.setData('text/plain', String(i)); }catch(_){}
    e.dataTransfer.effectAllowed = 'move';
    stNode.classList.add('dragging');
  });
  stNode.addEventListener('dragend', ()=>{ stNode.classList.remove('dragging'); });
  stNode.addEventListener('dragover', (e)=>{ e.preventDefault(); stNode.classList.add('drag-over'); });
  stNode.addEventListener('dragleave', ()=>{ stNode.classList.remove('drag-over'); });
  stNode.addEventListener('drop', (e)=>{
    e.preventDefault(); stNode.classList.remove('drag-over');
    let from = i;
    try{ const dt = e.dataTransfer.getData('text/plain'); if (dt) from = parseInt(dt,10); }catch(_){}
    const to = i;
    if (Number.isInteger(from) && from !== to){
      const [mv] = STAGES.splice(from,1);
      STAGES.splice(to,0,mv);
      saveStageConfig();
      renderGantt(); try{ refreshTaskPickers(); }catch(_){ }
    }
  });
  tree.appendChild(stNode);
  rows.push({type:'stage', project:proj, stage:st});

    });
  }
});

    const ROW_H = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h')) || 36;
    // Grid dimensions & guide rows
    grid.style.setProperty('--days', days);
    grid.style.setProperty('--colw', colw+'px');
    grid.style.setProperty('--grid-h', (rows.length*ROW_H + 20)+'px');
    grid.innerHTML='';
    for(let i=0;i<rows.length;i++){ const rl = document.createElement('div'); rl.className='rowline'; rl.style.top = (i*ROW_H)+'px'; grid.appendChild(rl); }

    function hasStageDayConflict(candidate, skipId){
  // candidate: { project, stage, start, end }
  for (const t of Object.values(tasks)) {
    if (skipId && t.id === skipId) continue;                 // ignore self on edit
    if (t.project === candidate.project && t.stage === candidate.stage) {
      const s1 = parseYMD(t.start), e1 = parseYMD(t.end);
      const s2 = parseYMD(candidate.start), e2 = parseYMD(candidate.end);
      if (!(e2 < s1 || s2 > e1)) return true;                // any overlap in same stage
    }
  }
  return false;
}

    // Place task bars (only on visible stage rows)
    Object.values(tasks).forEach(t=>{
      const idx = rows.findIndex(r => r.type==='stage' && r.project===t.project && r.stage===t.stage);
      if(idx===-1) return;
      const sDate = parseYMD(t.start), eDate = parseYMD(t.end);
      const yStart = new Date(state.year,0,1), yEnd = new Date(state.year,11,31);
      if(eDate < yStart || sDate > yEnd) return;
      const sClamp = sDate < yStart ? yStart : sDate;
      const eClamp = eDate > yEnd ? yEnd : eDate;

      const left = (dayOfYear(sClamp)-1) * colw;
      const span = Math.max(1, Math.floor((eClamp - sClamp)/86400000)+1);
      const BAR_H = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--bar-h')) || 22;
      const top = (idx*ROW_H) + Math.max(0, Math.floor((ROW_H - BAR_H)/2));
      const bar = document.createElement('div'); bar.className='bar'; bar.dataset.id = t.id;
      bar.style.left = left+'px'; bar.style.top = top+'px'; bar.style.width = (span*colw - 4)+'px';
      const color = t.color || STAGE_COLORS[t.stage] || '#74FBD6';
      bar.style.background = color; bar.style.color = pickText(color);
      bar.innerHTML = `<span class="label">${t.title}</span><span class="handles"><span class="h hr"></span></span>`;

      // Drag/resize
      let dragMode=null, startX=0, origS=t.start, origE=t.end, moved=false;
      bar.addEventListener('mousedown', (ev)=>{ if (ev.button !== 0) return;
        ev.preventDefault();
        startX = ev.clientX;
        const rect = bar.getBoundingClientRect(); const offsetX = ev.clientX - rect.left;
        dragMode = (offsetX > rect.width-10) ? 'right' : 'move';
        origS = t.start; origE = t.end;
        document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', onUp, {once:true});
      });
      function onDrag(ev){
        const dx = (ev.clientX - startX);
        const dd = Math.round(dx / colw); if(!dd) return; moved = true;
        let s = parseYMD(origS), e = parseYMD(origE);
        if(dragMode==='move'){ s = addDays(s, dd); e = addDays(e, dd); }
        else if(dragMode==='left'){ s = addDays(s, dd); if(s>e) s=e; }
        else if(dragMode==='right'){ e = addDays(e, dd); if(e<s) e=s; }
        const yS = new Date(state.year,0,1), yE = new Date(state.year,11,31);
        if(s < yS){ const shift = Math.floor((yS - s)/86400000); s = yS; if(dragMode==='move') e = addDays(e, shift); }
        if(e > yE){ const shift = Math.floor((e - yE)/86400000); e = yE; if(dragMode==='move') s = addDays(s, -shift); }
        const left2 = (dayOfYear(s)-1)*colw; const span2 = Math.max(1, Math.floor((e - s)/86400000)+1);
        bar.style.left = left2+'px'; bar.style.width = (span2*colw - 4)+'px';
      }
      
      function onUp(){
  document.removeEventListener('mousemove', onDrag);
  if(!moved){ openTaskDrawer(t); return; }

  const l = parseInt(bar.style.left,10) || 0;
  const w = parseInt(bar.style.width,10) || 0;
  const colStart2 = Math.round(l / colw) + 1;
  const span2     = Math.round((w + 4) / colw);
  const y0 = new Date(state.year, 0, 1);
  const newStart = addDays(y0, colStart2 - 1);
  const newEnd   = addDays(newStart, span2 - 1);

  t.start = toYMD(newStart);
  t.end   = toYMD(newEnd);

  tasks[t.id] = t;
  saveTasks();
  syncTaskToEvents(t);
  renderGantt(); try{ refreshTaskPickers(); }catch(_){ }
}

      // Click to open task drawer
      bar.addEventListener('click', (ev)=>{ ev.stopPropagation(); openTaskDrawer(t); });
      // Right-click: open Delete-only context menu (no color prompt)
      bar.addEventListener('contextmenu', (e) => {
        e.preventDefault(); e.stopPropagation();
        if (typeof showCtx === 'function') showCtx(e.clientX, e.clientY, t.id);
      });
      grid.appendChild(bar);
    });

    // Double-click empty grid to create task
    if(!grid._dblBound){ grid.addEventListener('dblclick', (ev)=>{ if (ev.button !== 0) return;
      const rect = grid.getBoundingClientRect();
      const col = Math.max(0, Math.floor((ev.clientX - rect.left) / colw));
      const y = ev.clientY - rect.top;
      const row = Math.floor(y / 36);
      const rowMap = []; // rebuild quick map
      let ry=0;
      PROJECTS.forEach(proj=>{ if(projectState[proj]?.open){ STAGES.forEach(st=>{ rowMap.push({project:proj,stage:st}); ry++; }); } });
      const r = rowMap[row]; if(!r) return;
      const y0 = new Date(state.year,0,1);
      const startD = addDays(y0, col);
      const id = 't' + Math.random().toString(36).slice(2,8) + Date.now().toString(36);
      const t = { id, title: 'New Task', project: r.project, stage: r.stage, start: toYMD(startD), end: toYMD(addDays(startD,1)), color: STAGE_COLORS[r.stage], startTime:'09:00', endTime:'10:00' };
      if (hasStageDayConflict(t)) { alert('Task overlaps another task in the same stage.'); return; }
tasks[id]=t; saveTasks(); syncTaskToEvents(t); renderGantt(); try{ refreshTaskPickers(); }catch(_){ }
    }); grid._dblBound = true; }

    // Delegated context menu fallback
    if(!grid._ctxBound){ grid.addEventListener('contextmenu', (e)=>{
      const barEl = e.target.closest('.bar');
      if(barEl){ e.preventDefault(); const id = barEl.dataset.id; if(typeof showCtx==='function') showCtx(e.clientX, e.clientY, id); }
    }); grid._ctxBound = true;

    // Header sync with body
    xbody.onscroll = ()=>{ const head = document.querySelector('.gantt-xhead'); if(head) head.scrollLeft = xbody.scrollLeft; };
    // Horizontal wheel scroll
    xbody.addEventListener('wheel', (e)=>{ e.preventDefault(); xbody.scrollLeft += (Math.abs(e.deltaY) > Math.abs(e.deltaX) ? e.deltaY : e.deltaX); }, {passive:false});
    // Drag the months header to scroll
    const xhead = document.querySelector('.gantt-xhead');
    let isDrag=false, sx=0, sl=0;
    if(xhead){
      xhead.addEventListener('mousedown', (e)=>{ if (e.button !== 0) return; isDrag=true; sx=e.clientX; sl=xbody.scrollLeft; document.body.classList.add('noselect'); xhead.classList.add('dragging'); });
      window.addEventListener('mousemove', (e)=>{ if(isDrag){ xbody.scrollLeft = sl - (e.clientX - sx); } });
      window.addEventListener('mouseup', ()=>{ isDrag=false; document.body.classList.remove('noselect'); if(xhead) xhead.classList.remove('dragging'); });
    }

  }};

const submitBtn = document.getElementById('submitBtn');
// Unified submit handler for Event Drawer (calendar + gantt task modes)
if (submitBtn) submitBtn.addEventListener('click', (e) => {
  e.preventDefault();

  const title = (titleInput.value || '').trim();
  if (!title) { titleInput.focus(); return; }

  // Build dates
  let sDate = startDateInput.value ? parseYMD(startDateInput.value) : (state.drawerDate || new Date());
  let eDate = endDateInput.value ? parseYMD(endDateInput.value) : sDate;
  if (eDate < sDate) { const tmp = sDate; sDate = eDate; eDate = tmp; }

  const evt = {
    title,
    start: startInput.value || '09:00',
    end: endInput.value || '10:00',
    color: colorInput.value,
    location: (document.getElementById('eventLocation')||{}).value || ''
  };

  // Optional: create a linked task if user checked Task and not editing an existing Gantt task
  if (taskFlag && taskFlag.checked && taskProject && taskProject.value && taskStage && taskStage.value && !state.ganttEditingId) {
    const id = 't' + Math.random().toString(36).slice(2,8) + Date.now().toString(36);
    const t = { id, title: evt.title, project: taskProject.value, stage: taskStage.value,
                start: toYMD(sDate), end: toYMD(eDate), color: evt.color, location: evt.location,
                startTime: evt.start, endTime: evt.end };
  if (hasStageDayConflict(t)) {
  alert('Another task exists on these dates in the same stage. Pick a different day.');
  return;
  }
    tasks[t.id] = t; saveTasks(); syncTaskToEvents(t);
    evt.taskId = id;
  }

  if (editing){
    deleteEvent(editing.key, editing.id);
    addEventToRange(sDate, eDate, evt);
    saveEvents();
    const prev = editing && editing.prevEvent;
    if (prev && prev.taskId && tasks[prev.taskId]){
      const t = tasks[prev.taskId];
      t.title = evt.title; t.color = evt.color; t.location = evt.location;
      t.start = toYMD(sDate); t.end = toYMD(eDate); t.startTime = evt.start; t.endTime = evt.end;
      tasks[t.id] = t; saveTasks(); syncTaskToEvents(t);
    }
    state.drawerDate = sDate; renderDayHours(state.drawerDate);
    renderGantt(); try{ refreshTaskPickers(); }catch(_){ }
    exitEditMode();
  } else if (state.ganttEditingId && tasks[state.ganttEditingId]){
    const t = tasks[state.ganttEditingId];
    t.title = evt.title; t.color = evt.color; t.location = evt.location;
    t.project = (taskProject && taskProject.value) || t.project;
    t.stage = (taskStage && taskStage.value) || t.stage;
    t.start = toYMD(sDate); t.end = toYMD(eDate); t.startTime = evt.start; t.endTime = evt.end;
    tasks[t.id] = t; saveTasks(); syncTaskToEvents(t); renderGantt(); try{ refreshTaskPickers(); }catch(_){ }
    closeDrawer();
  } else {
    addEventToRange(sDate, eDate, evt); saveEvents();
    state.drawerDate = sDate; renderDayHours(state.drawerDate); renderGantt(); try{ refreshTaskPickers(); }catch(_){ }
  }

  titleInput.value='';
});

  let stateGanttEditingId = null; // legacy
  // state.ganttEditingId will be set after state init;
  const taskProject = document.getElementById('taskProject');
  const taskStage = document.getElementById('taskStage');
  const taskFlag = document.getElementById('taskFlag');
  const todayBtn = document.getElementById('todayBtn');
  const yearPrev = document.getElementById('yearPrev');
  const yearNext = document.getElementById('yearNext');
  const yearLabel = document.getElementById('yearLabel');
  const menuBtn = document.getElementById('menuBtn');
  const menuPanel = document.getElementById('menuPanel');
  const menuClose = document.getElementById('menuClose');
  const scrim = document.getElementById('scrim');
  const exportBtn = document.getElementById('exportBtn');
  const importReplaceBtn = document.getElementById('importReplaceBtn');
  const importMergeBtn = document.getElementById('importMergeBtn');
  const importFile = document.getElementById('importFile');
  const searchBtn = document.getElementById('searchBtn');
  const searchOverlay = document.getElementById('searchOverlay');
  const searchInput = document.getElementById('searchInput');
  const searchList = document.getElementById('searchList');

  const state = { year: new Date().getFullYear(), drawerDate: null };
  state.ganttEditingId = null;
  let monthEls = [];
  let dateToCell = new Map();
  let selectedCell = null;
  let editing = null; // { key, id, chipEl }

  const pad = n => String(n).padStart(2,'0');
  const keyOf = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const isSameDate = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; };
  const toYMD = (d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const parseYMD = (s)=>{ const [y,m,d] = s.split('-').map(Number); const dt = new Date(y, (m||1)-1, d||1); dt.setHours(0,0,0,0); return dt; };
  const uid = ()=> 'e' + Math.random().toString(36).slice(2,8) + Date.now().toString(36);

  /* === Holidays (offline baked) + Country state === */
  const HOLIDAYS = {
    SG: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-29', name:"Chinese New Year (Day 1)"},
        {date:'2025-01-30', name:"Chinese New Year (Day 2)"},
        {date:'2025-03-31', name:"Hari Raya Puasa"},
        {date:'2025-04-18', name:"Good Friday"},
        {date:'2025-05-01', name:"Labour Day"},
        {date:'2025-05-12', name:"Vesak Day"},
        {date:'2025-06-07', name:"Hari Raya Haji"},
        {date:'2025-08-09', name:"National Day"},
        {date:'2025-10-20', name:"Deepavali"},
        {date:'2025-12-25', name:"Christmas Day"}
      ]
    }
    ,MY: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-29', name:"Chinese New Year (Day 1)"},
        {date:'2025-01-30', name:"Chinese New Year (Day 2)"},
        {date:'2025-03-31', name:"Hari Raya Aidilfitri (Day 1)"},
        {date:'2025-04-01', name:"Hari Raya Aidilfitri (Day 2)"},
        {date:'2025-05-01', name:"Labour Day"},
        {date:'2025-05-12', name:"Wesak Day"},
        {date:'2025-06-02', name:"Agong's Birthday"},
        {date:'2025-06-07', name:"Hari Raya Haji"},
        {date:'2025-06-27', name:"Awal Muharram"},
        {date:'2025-08-31', name:"Merdeka Day"},
        {date:'2025-09-05', name:"Maulidur Rasul"},
        {date:'2025-09-16', name:"Malaysia Day"},
        {date:'2025-10-20', name:"Deepavali"},
        {date:'2025-12-25', name:"Christmas Day"}
      ]
    }
    ,CN: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-28', name:"Spring Festival Holiday"},
        {date:'2025-01-29', name:"Spring Festival Holiday"},
        {date:'2025-01-30', name:"Spring Festival Holiday"},
        {date:'2025-01-31', name:"Spring Festival Holiday"},
        {date:'2025-02-01', name:"Spring Festival Holiday"},
        {date:'2025-02-02', name:"Spring Festival Holiday"},
        {date:'2025-02-03', name:"Spring Festival Holiday"},
        {date:'2025-02-04', name:"Spring Festival Holiday"},
        {date:'2025-04-04', name:"Qingming Festival"},
        {date:'2025-04-05', name:"Qingming Festival"},
        {date:'2025-04-06', name:"Qingming Festival"},
        {date:'2025-05-01', name:"Labor Day Holiday"},
        {date:'2025-05-02', name:"Labor Day Holiday"},
        {date:'2025-05-03', name:"Labor Day Holiday"},
        {date:'2025-05-04', name:"Labor Day Holiday"},
        {date:'2025-05-05', name:"Labor Day Holiday"},
        {date:'2025-05-31', name:"Dragon Boat Festival"},
        {date:'2025-06-01', name:"Dragon Boat Festival"},
        {date:'2025-06-02', name:"Dragon Boat Festival"},
        {date:'2025-10-01', name:"National Day / Mid-Autumn"},
        {date:'2025-10-02', name:"National Day / Mid-Autumn"},
        {date:'2025-10-03', name:"National Day / Mid-Autumn"},
        {date:'2025-10-04', name:"National Day / Mid-Autumn"},
        {date:'2025-10-05', name:"National Day / Mid-Autumn"},
        {date:'2025-10-06', name:"National Day / Mid-Autumn"},
        {date:'2025-10-07', name:"National Day / Mid-Autumn"},
        {date:'2025-10-08', name:"National Day / Mid-Autumn"}
      ]
    }
    ,TW: {
      2025: [
        {date:'2025-01-01', name:"Republic Day"},
        {date:'2025-01-27', name:"Lunar New Year Holiday"},
        {date:'2025-01-28', name:"Lunar New Year's Eve"},
        {date:'2025-01-29', name:"Lunar New Year Day"},
        {date:'2025-01-30', name:"Lunar New Year Holiday"},
        {date:'2025-01-31', name:"Lunar New Year Holiday"},
        {date:'2025-02-01', name:"Lunar New Year Holiday"},
        {date:'2025-02-02', name:"Lunar New Year Holiday"},
        {date:'2025-02-28', name:"Peace Memorial Day"},
        {date:'2025-04-04', name:"Children's Day & Tomb Sweeping Day"},
        {date:'2025-05-01', name:"Labor Day (private sector)"},
        {date:'2025-05-31', name:"Dragon Boat Festival"},
        {date:'2025-10-06', name:"Mid-Autumn Festival"},
        {date:'2025-10-10', name:"National Day"}
      ]
    }
    ,JP: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-13', name:"Coming of Age Day"},
        {date:'2025-02-11', name:"National Foundation Day"},
        {date:'2025-02-23', name:"Emperor's Birthday"},
        {date:'2025-02-24', name:"Emperor's Birthday (Observed)"},
        {date:'2025-03-20', name:"Vernal Equinox Day"},
        {date:'2025-04-29', name:"ShÅwa Day"},
        {date:'2025-05-03', name:"Constitution Memorial Day"},
        {date:'2025-05-04', name:"Greenery Day"},
        {date:'2025-05-05', name:"Children's Day"},
        {date:'2025-05-06', name:"Holiday (Observed)"},
        {date:'2025-07-21', name:"Marine Day"},
        {date:'2025-08-11', name:"Mountain Day"},
        {date:'2025-09-15', name:"Respect for the Aged Day"},
        {date:'2025-09-23', name:"Autumnal Equinox Day"},
        {date:'2025-10-13', name:"Sports Day"},
        {date:'2025-11-03', name:"Culture Day"},
        {date:'2025-11-23', name:"Labor Thanksgiving Day"},
        {date:'2025-11-24', name:"Labor Thanksgiving (Observed)"}
      ]
    }
    ,US: {
      2025: [
        {date:'2025-01-01', name:"New Year's Day"},
        {date:'2025-01-20', name:"Martin Luther King Jr. Day"},
        {date:'2025-02-17', name:"Washington's Birthday"},
        {date:'2025-05-26', name:"Memorial Day"},
        {date:'2025-06-19', name:"Juneteenth National Independence Day"},
        {date:'2025-07-04', name:"Independence Day"},
        {date:'2025-09-01', name:"Labor Day"},
        {date:'2025-10-13', name:"Columbus Day"},
        {date:'2025-11-11', name:"Veterans Day"},
        {date:'2025-11-27', name:"Thanksgiving Day"},
        {date:'2025-12-25', name:"Christmas Day"}
      ]
    }

  };
  let currentCountry = localStorage.getItem('country') || 'SG';
  const countrySelect = document.getElementById('countrySelect');
  if (countrySelect){ countrySelect.value = currentCountry; }

  function getHoliday(country, d){
    const key = (typeof d === 'string') ? d : keyOf(d);
    const year = Number(key.slice(0,4));
    const list = (HOLIDAYS[country] && HOLIDAYS[country][year]) || [];
    const hit = list.find(h => h.date === key);
    return hit ? hit.name : null;
  }
  function setHolidayIcon(cell, on){
    cell.classList.toggle('holiday', !!on);
    cell.querySelectorAll('.holiday-icon').forEach(n=>n.remove());
  }
  function decorateMonthHolidays(){
    // iterate through currently built cells for this year
    dateToCell.forEach((cell, key)=>{
      if(!key.startsWith(String(state.year))) return;
      const isHol = !!getHoliday(currentCountry, key);
      setHolidayIcon(cell, isHol);
    if(dayColors[key]) applyDayColor(cell, dayColors[key]);
    });
  }

  function monthMatrix(y,m){ const first = new Date(y,m,1); const start = addDays(first, -first.getDay()); const grid=[]; for(let i=0;i<42;i++) grid.push(addDays(start,i)); return grid; }
  function loadEvents(){ let data={}; try{ data = JSON.parse(localStorage.getItem(STORAGE_KEY))||{} }catch(e){ data = {} } Object.keys(data).forEach(k=>{ data[k].forEach(ev=>{ if(!ev.id) ev.id = uid(); }); }); return data; }
  function saveEvents(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); }

  let events = loadEvents();

  
  /* === Personalized Day Colors === */
  const COLOR_KEY = 'DAY_COLORS';
  function loadDayColors(){ try{ return JSON.parse(localStorage.getItem(COLOR_KEY))||{} }catch(e){ return {} } }
  function saveDayColors(){ localStorage.setItem(COLOR_KEY, JSON.stringify(dayColors)); }
  let dayColors = loadDayColors();

  function hexToRgb(hex){ const m = hex.replace('#',''); const n = parseInt(m,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
  function luminance(hex){ const {r,g,b} = hexToRgb(hex); const sr=[r,g,b].map(v=>{v/=255; return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4)}); return 0.2126*sr[0]+0.7152*sr[1]+0.0722*sr[2]; }
  function pickText(hex){ try{ return luminance(hex) > 0.5 ? '#153960' : '#FFFFFF'; }catch(e){ return '#FFFFFF'; } }
  function applyDayColor(cell, hex){
    const btn = cell.querySelector('.daynum'); if(!btn) return;
    if(hex){
      btn.style.background = hex;
      btn.style.borderColor = '#FFFFFF';
      btn.style.color = pickText(hex);
      cell.classList.add('custom');
    }else{
      btn.style.background = ''; btn.style.borderColor = ''; btn.style.color = ''; cell.classList.remove('custom');
    }
  }

  let colorMenu, colorPicker, colorClear, colorTargetKey=null, colorTargetCell=null;
  function ensureColorMenu(){
    colorMenu = document.getElementById('dayColorMenu');
    colorPicker = document.getElementById('dayColorPicker');
    colorClear = document.getElementById('dayColorClear');
    if(!colorMenu || !colorPicker || !colorClear) return;
    if(!colorMenu.dataset.ready){
      colorPicker.addEventListener('input', ()=>{
        const keys = getSelectedKeys();
        const val = colorPicker.value;
        if(keys.length){
          keys.forEach(k=>{ dayColors[k]=val; const cell = dateToCell.get(k); if(cell) applyDayColor(cell, val); });
          saveDayColors();
        } else if(colorTargetKey && colorTargetCell){
          dayColors[colorTargetKey]=val; saveDayColors(); applyDayColor(colorTargetCell, val);
        }
      });
      colorClear.addEventListener('click', ()=>{
        const keys = getSelectedKeys();
        if(keys.length){
          keys.forEach(k=>{ delete dayColors[k]; const cell = dateToCell.get(k); if(cell) applyDayColor(cell, null); });
          saveDayColors();
        } else if(colorTargetKey && colorTargetCell){
          delete dayColors[colorTargetKey]; saveDayColors(); applyDayColor(colorTargetCell, null);
        }
        closeDayColorMenu();
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDayColorMenu(); });
      document.addEventListener('click', (e)=>{
        if(colorMenu.getAttribute('aria-hidden')==='false' && !colorMenu.contains(e.target)) closeDayColorMenu();
      }, true);
      colorMenu.dataset.ready = '1';

      // init swatches
      const swatchWrap = document.getElementById('dayColorSwatches');
      if(swatchWrap && !swatchWrap.dataset.ready){
        swatchWrap.querySelectorAll('.swatch').forEach(btn=>{
        const c = btn.dataset.color; if(c) btn.style.background = c;
        btn.addEventListener('click', ()=>{
          const keys = getSelectedKeys();
          const val = c;
          if(keys.length){
            keys.forEach(k=>{ dayColors[k]=val; const cell = dateToCell.get(k); if(cell) applyDayColor(cell, val); });
            saveDayColors();
          }else if(colorTargetKey && colorTargetCell){
            dayColors[colorTargetKey]=val; saveDayColors(); applyDayColor(colorTargetCell, val);
          }
          closeDayColorMenu();
        });
      });
        swatchWrap.dataset.ready = '1';
      }
    }
  }
  function openDayColorMenu(cell, key, x, y){
    ensureColorMenu(); if(!colorMenu) return;
    colorTargetCell = cell; colorTargetKey = key;
    colorPicker.value = dayColors[key] || '#2EA1FF';
    colorMenu.style.right = '';
    colorMenu.style.bottom = '';
    colorMenu.style.left = Math.min(x, window.innerWidth-300) + 'px';
    colorMenu.style.top  = Math.min(y, window.innerHeight-80) + 'px';
    colorMenu.setAttribute('aria-hidden','false'); colorMenu.hidden = false;
  }
  function closeDayColorMenu(){
    if(!colorMenu) return;
    colorMenu.setAttribute('aria-hidden','true'); colorMenu.hidden = true;
    colorTargetCell=null; colorTargetKey=null;
  }

  /* === Selection model (single click vs shift+click vs drag) === */
  let primaryKey = null;          // single-click selection
  const multiKeys = new Set();    // additive shift+click or drag selection
  let isDragging = false;
  let dragAnchorKey = null;

  function clearSelection(){
    primaryKey = null; multiKeys.clear();
    refreshSelectionClasses();
  }
  function selectSingle(key){
    primaryKey = key; multiKeys.clear();
    refreshSelectionClasses();
  }
  function addMulti(key){
    multiKeys.add(key);
    refreshSelectionClasses();
  }
  function keysMinMax(){
    const arr = Array.from(multiKeys);
    if(primaryKey) arr.push(primaryKey);
    if(arr.length===0) return null;
    arr.sort();
    return {start: arr[0], end: arr[arr.length-1]};
  }
  function updateDrawerFromSelection(){
    const mm = keysMinMax();
    if(mm && typeof startDateInput!=='undefined' && startDateInput && endDateInput){
      startDateInput.value = mm.start;
      endDateInput.value = mm.end;
    }
  }
  function refreshSelectionClasses(){
    // strip old classes
    dateToCell.forEach((cell)=>{ cell.classList.remove('selected-single','selected-multi','range'); });
    // apply current
    if(primaryKey){ const cell = dateToCell.get(primaryKey); if(cell) cell.classList.add('selected-single'); }
    multiKeys.forEach(k=>{ const cell = dateToCell.get(k); if(cell) cell.classList.add('selected-multi'); });
    updateDrawerFromSelection();
  }
  function setDragRange(toKey){
    if(!dragAnchorKey) return;
    // fill multiKeys with contiguous range between anchor and toKey
    multiKeys.clear();
    const a = parseYMD(dragAnchorKey), b = parseYMD(toKey);
    const dir = a <= b ? 1 : -1;
    let d = dir===1 ? new Date(a) : new Date(b);
    const end = dir===1 ? b : a;
    while(true){
      multiKeys.add(keyOf(d));
      if(d.getTime() === end.getTime()) break;
      d.setDate(d.getDate()+1);
    }
    primaryKey = null;
    refreshSelectionClasses();
  }

  function getSelectedKeys(){
    const arr = Array.from(multiKeys || []);
    if (typeof primaryKey !== 'undefined' && primaryKey) arr.push(primaryKey);
    return Array.from(new Set(arr)).sort();
  }
function buildYear(){
    yearLabel.textContent = state.year;
    canvas.innerHTML = '';
    monthEls = []; dateToCell.clear(); selectedCell = null;
    const today = new Date();
    for(let m=0;m<12;m++){
      const sec = document.createElement('section'); sec.className = 'month-section'; sec.dataset.month = m;
      const back = document.createElement('div'); back.className = 'month-back'; back.style.setProperty('--tone-gradient', `linear-gradient(180deg, ${tones[m][0]}, ${tones[m][1]})`); sec.appendChild(back);
      const chip = document.createElement('div'); chip.className = 'month-chip'; chip.textContent = months[m]; sec.appendChild(chip);
      const grid = document.createElement('div'); grid.className = 'month-grid';
      const mat = monthMatrix(state.year, m);
      mat.forEach(d=>{
        const cell = document.createElement('div'); cell.className='cell'; cell.dataset.date = keyOf(d);
        if(d.getMonth()!==m) cell.classList.add('out');
        if(isSameDate(d,today)) cell.classList.add('today');
        if(d.getMonth()===m){ const __dow=d.getDay(); if(__dow===0) cell.classList.add('sun'); else if(__dow===6) cell.classList.add('sat'); }
        const btn = document.createElement('button'); btn.className='daynum'; btn.type='button'; btn.textContent = d.getDate(); btn.ariaLabel = d.toDateString();
        
        // New selection handlers
        btn.addEventListener('mousedown', (e)=>{ if (e.button !== 0) return;
          if(e.button!==0) return;
          if(e.shiftKey){ /* start additive range drag */ isDragging = true; dragAnchorKey = keyOf(d); setDragRange(dragAnchorKey); }
          else { /* start contiguous drag interpreted as multi */ isDragging = true; dragAnchorKey = keyOf(d); setDragRange(dragAnchorKey); }
          e.preventDefault();
        });
        btn.addEventListener('mouseenter', (e)=>{
          if(!isDragging) return;
          setDragRange(keyOf(d));
        });
        btn.addEventListener('mouseup', (e)=>{
          if(!isDragging) return;
          isDragging = false;
        });
        btn.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const k = keyOf(d);
          if(ev.shiftKey){
            addMulti(k);
          }else{
            selectSingle(k);
          }
          openDrawer(d);
        });
btn.addEventListener('contextmenu', (e)=>{ e.preventDefault(); openDayColorMenu(cell, keyOf(d), e.clientX, e.clientY); });
        cell.appendChild(btn); grid.appendChild(cell);
        const k = keyOf(d); dateToCell.set(k, cell);
        if(events[k] && events[k].length){ setMarker(cell, events[k][0].color); }
        if(getHoliday(currentCountry, d)){ setHolidayIcon(cell, true); }
        if(dayColors[k]) applyDayColor(cell, dayColors[k]);
      });
      sec.appendChild(grid);
      canvas.appendChild(sec); monthEls.push(sec);
    }
    setActiveMonthByScroll();
  }

  function selectCell(cell){
    if(selectedCell) selectedCell.classList.remove('selected');
    selectedCell = cell; if(selectedCell) selectedCell.classList.add('selected');
  }

  function setActiveMonthByScroll(){
    const viewportTop = canvas.scrollTop;
    const viewportMid = viewportTop + canvas.clientHeight * 0.25;
    let closest = null; let bestDist = Infinity;
    monthEls.forEach(sec=>{ const dist = Math.abs(sec.offsetTop - viewportMid); if(dist < bestDist){ bestDist = dist; closest = sec; } });
    monthEls.forEach(sec=> sec.classList.toggle('active', sec===closest));
  }
  canvas.addEventListener('scroll', setActiveMonthByScroll, {passive:true});
  document.addEventListener('mouseup', (e)=>{ if(isDragging){ isDragging=false; } });
  canvas.addEventListener('click', (e)=>{ if(e.target===canvas){ clearSelection(); } });
  function openDrawer(date){
  exitEditMode();
    state.drawerDate = new Date(date);
    drawerTitle.textContent = `${dows[date.getDay()]} Â· ${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
    const mmSel = keysMinMax();
    if(mmSel){ startDateInput.value = mmSel.start; endDateInput.value = mmSel.end; }
    else { startDateInput.value = toYMD(date); endDateInput.value = toYMD(date); }
    
    const now = new Date();
    startInput.value = String(now.getHours()).padStart(2,'0') + ':00';
    endInput.value = String((now.getHours()+1)%24).padStart(2,'0') + ':00';
    titleInput.value = ''; locationInput.value=''; colorInput.value = '#74FBD6';
    renderDayHours(date);
  drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
  }
  function closeDrawer(){
  document.body.classList.remove('taskmode');
  if (typeof state !== 'undefined') state.ganttEditingId = null;
  const tf = document.getElementById('taskFlag'); if(tf) tf.disabled = false;
  const drawer = document.getElementById('drawer');
  if (drawer){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }
  exitEditMode();
}

  function renderDayHours(date){
    drawerHours.innerHTML = '';
    const holName = getHoliday(currentCountry, date);
    if(holName){
      const strip = document.createElement('div'); strip.className='holiday-strip';
      strip.innerHTML = `<span class="tag">Public Holiday</span> ${holName}`;
      drawerHours.appendChild(strip);
    }
    const key = keyOf(date); const list = events[key] || [];
    if(!list.length){
      const boxL = document.createElement('div'); boxL.className='empty-box'; boxL.textContent='Empty Schedule';
      drawerHours.appendChild(boxL);
      return;
    }
    const items = list.map(e=>e).sort((a,b)=> a.start.localeCompare(b.start));
    items.forEach((e)=>{
      const lab = document.createElement('div'); lab.className='hour-lbl'; lab.textContent = e.start;
      const slot = document.createElement('div'); slot.className='hour-slot';
      const chip = document.createElement('div'); chip.className='event-chip'; chip.style.setProperty('--chip', e.color || '#fff');
      const loc = e.location ? ` â€¢ ${e.location}` : '';
      chip.innerHTML = `<strong>${e.title}</strong> <small>${e.start}â€“${e.end}${loc}</small>`;
      const actions = document.createElement('div'); actions.className='actions';
      const edit = document.createElement('button'); edit.textContent='âœŽ'; edit.title='Edit';
      edit.onclick = ()=>{ enterEditMode(key, e.id, chip, e); };
      const del = document.createElement('button'); del.textContent='Ã—'; del.title='Delete';
      del.onclick = ()=>{ deleteCalendarEvent(key, e.id); };
      actions.appendChild(edit); actions.appendChild(del); chip.appendChild(actions);
      slot.appendChild(chip);
      drawerHours.appendChild(lab); drawerHours.appendChild(slot);
    });
  }

  function setMarker(cell, color){
    cell.querySelectorAll('.event-dot').forEach(n=>n.remove());
    const dot = document.createElement('span'); dot.className='event-dot'; dot.style.setProperty('--dot', color||'#fff');
    cell.appendChild(dot);
  }

  function updateMarkerForKey(key){
    const cell = dateToCell.get(key);
    if(!cell) return;
    cell.querySelectorAll('.event-dot').forEach(n=>n.remove());
    if(events[key] && events[key].length){ setMarker(cell, events[key][0].color); } else { /* keep event marker removed if no events */ }
    // refresh holiday icon state
    const isHol = !!getHoliday(currentCountry, key);
    setHolidayIcon(cell, isHol);
  }

  function deleteEvent(key, id){
  const list = events[key]; if(!list) return;
  const idx = list.findIndex(ev=>ev.id===id);
  if (idx > -1){
    list.splice(idx,1);
    if(!list.length) delete events[key];
  }
  saveEvents();
  if (state.drawerDate && keyOf(state.drawerDate)===key) renderDayHours(state.drawerDate);
  updateMarkerForKey(key);
  if (editing && editing.key===key && editing.id===id){ exitEditMode(); }
}

function deleteCalendarEvent(key, id){
  const list = events[key]; if(!list) return;
  const ev = list.find(ev=>ev.id===id);
  // remove from day
  events[key] = list.filter(ev=>ev.id!==id);
  if (!events[key].length) delete events[key];
  updateMarkerForKey(key);
  // if mirrored from Gantt task, delete task + all mirrors
  if (ev && ev.taskId && tasks[ev.taskId]){
    delete tasks[ev.taskId]; saveTasks();
    try{ removeTaskEventInstances(ev.taskId); }catch(_){}
  }
  saveEvents();
  if (state.drawerDate && keyOf(state.drawerDate)===key) renderDayHours(state.drawerDate);
  try{ if (typeof renderGantt === 'function') renderGantt(); try{ refreshTaskPickers(); }catch(_){ } }catch(_){}
  if (editing && editing.key===key && editing.id===id){ exitEditMode(); }
}

function addEventToRange(startDate, endDate, evt){
  const s = parseYMD(toYMD(startDate));
  const e = parseYMD(toYMD(endDate));
  for(let d=new Date(s); d<=e; d=addDays(d,1)){
    const k = keyOf(d);
    if(!events[k]) events[k]=[];
    events[k].push(Object.assign({id: uid()}, evt));
    updateMarkerForKey(k);
  }
}
function enterEditMode(key, id, chipEl, e){
  try{ setEditPanel(true); }catch(e){}
    exitEditMode();
    editing = { key, id, chipEl, prevEvent: e };
    chipEl.classList.add('editing');
    submitBtn.textContent = 'Edit';
    titleInput.value = e.title || '';
    startDateInput.value = toYMD(state.drawerDate);
    endDateInput.value = toYMD(state.drawerDate);
    startInput.value = e.start || '09:00';
    endInput.value = e.end || '10:00';
    locationInput.value = e.location || '';
    colorInput.value = e.color || '#74FBD6';
  }

  function exitEditMode(){
  // Leave edit mode without mutating data; form submit handles saves.
  editing = null;
  const tf = document.getElementById('taskFlag'); if(tf) tf.disabled = false;
}


  const drawerCloseBtn = document.getElementById('drawerClose'); if(drawerCloseBtn) drawerCloseBtn.addEventListener('click', closeDrawer);
  
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      if(searchOverlay.classList.contains('open')) closeSearch();
      else if(menuPanel.classList.contains('open')) closeMenu();
      // else closeDrawer();  // disabled: drawer only closes via its Close button
    }
  });

  todayBtn.addEventListener('click', ()=>{
    const today = new Date();
    if (today.getFullYear() !== state.year){
      state.year = today.getFullYear();
      buildYear();
      renderGantt(); try{ refreshTaskPickers(); }catch(_){ }
    }
    const m = today.getMonth();
    monthEls[m].scrollIntoView({behavior:'smooth', block:'start'});
    setTimeout(()=> setActiveMonthByScroll(), 300);
  });

  yearPrev.addEventListener('click', ()=>{ state.year--; buildYear(); decorateMonthHolidays(); renderGantt(); try{ refreshTaskPickers(); }catch(_){ } canvas.scrollTop = 0; });
  yearNext.addEventListener('click', ()=>{ state.year++; buildYear(); decorateMonthHolidays(); renderGantt(); try{ refreshTaskPickers(); }catch(_){ } canvas.scrollTop = 0; });

  /* Country selector */
  if (countrySelect){
    countrySelect.addEventListener('change', ()=>{
      currentCountry = countrySelect.value;
      localStorage.setItem('country', currentCountry);
      decorateMonthHolidays();
      if(state.drawerDate) renderDayHours(state.drawerDate);
    });
  }


  /* Data & Sync (Menu) */
  function openMenu(){ menuPanel.classList.add('open'); scrim.classList.add('show'); }
  function closeMenu(){ menuPanel.classList.remove('open'); scrim.classList.remove('show'); }
  menuBtn.addEventListener('click', openMenu);
  menuClose.addEventListener('click', closeMenu);
  scrim.addEventListener('click', ()=>{
    if(menuPanel.classList.contains('open')) closeMenu();
    if(searchOverlay.classList.contains('open')) closeSearch();
  });

  function exportJSON(){
    const payload = { events, dayColors, country: currentCountry, tasks, projectState };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    const now = new Date();
    const fname = `calendar-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.json`;
    a.href = URL.createObjectURL(blob); a.download = fname; a.click(); URL.revokeObjectURL(a.href);
  }
  exportBtn.addEventListener('click', exportJSON);

  let importMode = 'replace';
  importReplaceBtn.addEventListener('click', ()=>{ importMode='replace'; importFile.click(); });
  importMergeBtn.addEventListener('click', ()=>{ importMode='merge'; importFile.click(); });
  importFile.addEventListener('change', ()=>{
    const file = importFile.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(data && (data.events || data.tasks)){
          if(importMode==='replace'){ events = {}; dayColors = {}; }
          for(const [k, arr] of Object.entries(data.events||{})){
            if(!Array.isArray(arr)) continue;
            if(!events[k]) events[k] = [];
            arr.forEach(ev=>{ if(!ev.id) ev.id = uid(); events[k].push(ev); });
          }
          for(const [k, val] of Object.entries(data.dayColors||{})){
            if(val) dayColors[k] = val; else delete dayColors[k];
          }
          if(data.country){ currentCountry = data.country; if(countrySelect) countrySelect.value = currentCountry; }
          if(data.tasks){ tasks = data.tasks||{}; saveTasks(); }
          if(data.projectState){ projectState = data.projectState||projectState; saveProjectState(); }
          saveEvents(); saveDayColors(); buildYear(); decorateMonthHolidays(); closeMenu();
        } else {
          if(importMode==='replace'){ events = {}; }
          for(const [k, arr] of Object.entries(data||{})){
            if(!Array.isArray(arr)) continue;
            if(!events[k]) events[k] = [];
            arr.forEach(ev=>{ if(!ev.id) ev.id = uid(); events[k].push(ev); });
          }
          saveEvents(); buildYear(); decorateMonthHolidays(); closeMenu();
        }
      }catch(err){ alert('Invalid JSON.'); }
      importFile.value='';
    };
    reader.readAsText(file);
  });

  /* Search overlay */
  function openSearch(){ searchOverlay.classList.add('open'); searchOverlay.setAttribute('aria-hidden','false'); searchInput.value=''; renderSearch(''); setTimeout(()=>searchInput.focus(), 0); }
  function closeSearch(){ searchOverlay.classList.remove('open'); searchOverlay.setAttribute('aria-hidden','true'); }
  searchBtn.addEventListener('click', openSearch);
  document.addEventListener('keydown', (e)=>{
    const mod = e.ctrlKey || e.metaKey;
    if(mod && e.key.toLowerCase()==='k'){ e.preventDefault(); openSearch(); }
  });

  function fuzzyScore(q, s){
    q=q.trim().toLowerCase(); s=(s||'').toLowerCase();
    if(!q) return 0;
    let qi=0, score=0, last=-1;
    for(let i=0;i<s.length && qi<q.length;i++){
      if(s[i]===q[qi]){
        score += (last>=0 ? Math.max(2 - (i-last-1)*0.15, 0.2) : 1.0);
        last=i; qi++;
      }
    }
    return qi===q.length ? score : 0;
  }
  function parseQuickDate(q){
    q=q.trim().toLowerCase(); if(!q) return null;
    if(q==='today'){ return new Date(); }
    if(/^\d{4}-\d{2}-\d{2}$/.test(q)){ const d=parseYMD(q); return d; }
    const mname = months.map(m=>m.toLowerCase());
    for(let i=0;i<mname.length;i++){
      const re = new RegExp(`^${mname[i].slice(0,3)}[a-z]*\\s+(\\d{1,2})$`);
      const m = q.match(re);
      if(m){ const d = new Date(state.year, i, Number(m[1])); d.setHours(0,0,0,0); return d; }
    }
    return null;
  }
  function formatDate(d){ return `${dows[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`; }
  function buildSearchItems(){ const items=[]; for(const [k,list] of Object.entries(events)){ const d=parseYMD(k); for(const e of list){ items.push({k, d, e}); } } return items; }

  let selIndex = -1;
  function renderSearch(q){
    const listEl = searchList; listEl.innerHTML=''; selIndex = -1;
    const items = buildSearchItems();
    const results = [];
    const jumpDate = parseQuickDate(q);
    if(jumpDate){ results.push({type:'jump', d:jumpDate, label:`Go to ${formatDate(jumpDate)}`, score:999}); }
    if(q.trim()){
      items.forEach(({k,d,e})=>{
        const text = `${e.title} ${e.location||''}`;
        const sc = fuzzyScore(q, text);
        if(sc>0){ results.push({type:'event', k, d, e, score:sc}); }
      });
    }
    results.sort((a,b)=> b.score - a.score);
    if(!results.length){ const li=document.createElement('li'); li.innerHTML='<span class="badge">No results</span>'; listEl.appendChild(li); return; }
    results.slice(0,50).forEach((r,idx)=>{
      const li = document.createElement('li');
      if(r.type==='jump'){
        li.innerHTML = `<span class="badge">Jump</span> ${r.label}`;
        li.onclick = ()=>{ jumpToDate(r.d); closeSearch(); };
      } else {
        const time = (r.e.start||'').padEnd(5,'0');
        const label = `${formatDate(r.d)} â€” ${r.e.title}` + (r.e.location?` â€¢ ${r.e.location}`:'');
        li.innerHTML = `<span class="badge">${time}</span> ${label}`;
        li.onclick = ()=>{ jumpToDate(r.d); closeSearch(); };
      }
      if(idx===0) { li.classList.add('active'); selIndex=0; }
      listEl.appendChild(li);
    });
  }

  searchInput.addEventListener('input', (e)=> renderSearch(e.target.value));
  searchInput.addEventListener('keydown', (e)=>{
    const items = Array.from(searchList.querySelectorAll('li'));
    if(e.key==='ArrowDown'){
      e.preventDefault();
      if(items.length){
        items[selIndex]?.classList.remove('active');
        selIndex = Math.min(items.length-1, selIndex+1);
        items[selIndex].classList.add('active');
        items[selIndex].scrollIntoView({block:'nearest'});
      }
    }
    else if(e.key==='ArrowUp'){
      e.preventDefault();
      if(items.length){
        items[selIndex]?.classList.remove('active');
        selIndex = Math.max(0, selIndex-1);
        items[selIndex].classList.add('active');
        items[selIndex].scrollIntoView({block:'nearest'});
      }
    }
    else if(e.key==='Enter'){
      e.preventDefault();
      if(items.length && selIndex>=0){ items[selIndex].click(); }
    }
    else if(e.key==='Escape'){ closeSearch(); }
  });

  function jumpToDate(date){
    if(date.getFullYear() !== state.year){ state.year = date.getFullYear(); buildYear(); }
    const m = date.getMonth();
    monthEls[m].scrollIntoView({behavior:'smooth', block:'start'});
    const k = keyOf(date); const cell = dateToCell.get(k);
    if(cell){ selectCell(cell); openDrawer(date); }
  }

  buildYear();
  decorateMonthHolidays();
  renderGantt(); try{ refreshTaskPickers(); }catch(_){ }
  


(function bindInlineEditing(){
  const tree = document.getElementById('ganttTree');
  if (!tree || tree._inlineBound) return;
  tree._inlineBound = true;

  // Enter = save; Esc = cancel
  tree.addEventListener('keydown', (e)=>{
    const el = e.target.closest('.label.editable');
    if (!el) return;
    if (e.key === 'Enter') { e.preventDefault(); el.blur(); }
    if (e.key === 'Escape') { e.preventDefault(); el.textContent = el.dataset.old || el.textContent; el.blur(); }
  }, true);

  // Save on blur
  tree.addEventListener('blur', (e)=>{
    const el = e.target.closest('.label.editable');
    if (!el) return;
    const oldName = el.dataset.old || '';
    const newName = (el.textContent || '').trim();
    const type = el.dataset.type;
    if (!newName || newName === oldName) { el.textContent = oldName; return; }
    let ok = false;
    if (type === 'project') ok = window.renameProject(oldName, newName);
    else if (type === 'stage') ok = window.renameStage(oldName, newName);
    if (!ok) el.textContent = oldName;
    else el.dataset.old = newName;
  }, true);
})();




/* === Gantt UI prefs, zoom, and resize =================================== */
  const root = document.documentElement;
  const prefsKey = 'GANTT_UI_PREFS_V1';
  function getNumVar(name, fallback){
    const v = getComputedStyle(root).getPropertyValue(name).trim();
    const n = parseFloat(v||''); return (Number.isFinite(n) ? n : fallback);
  }
  function setVar(name, val){ root.style.setProperty(name, typeof val==='number'? (val+'px') : String(val)); }

  // Load saved prefs
  const saved = (()=>{ try{return JSON.parse(localStorage.getItem(prefsKey)||'{}')}catch(_){return{}} })();
  if (saved.gcol) setVar('--gcol', saved.gcol);
  if (saved.rowH) setVar('--row-h', saved.rowH);
  if (saved.barH) setVar('--bar-h', saved.barH);
  if (saved.fontSize) setVar('--gantt-font-size', saved.fontSize);
  if (saved.fontFamily) setVar('--gantt-font-family', saved.fontFamily);
  if (saved.fontWeight) setVar('--gantt-font-weight', saved.fontWeight);
  if (typeof saved.fontColor !== 'undefined' && saved.fontColor !== '') setVar('--gantt-font-color', saved.fontColor);
  if (saved.ganttW) setVar('--gantt-w', saved.ganttW);
  if (saved.leftW) setVar('--gantt-left-w', saved.leftW);

  // Wire controls
  const zoomSlider = document.getElementById('zoomSlider');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const rowHeight = document.getElementById('rowHeight');
  const fontSize  = document.getElementById('fontSize');
  const fontFamily= document.getElementById('fontFamily');
  const fontColor = document.getElementById('fontColor');

  // Initialize UI from current CSS values
  try{
    if (zoomSlider){ const v = getNumVar('--gcol', 20); zoomSlider.value = Math.round(v); }
    if (rowHeight){ rowHeight.value = getNumVar('--row-h', 36); }
    if (fontSize){ fontSize.value = getNumVar('--gantt-font-size', 12); }
    if (fontFamily){ /* leave default option unless user changes */ }
    if (fontColor){ const c = (getComputedStyle(root).getPropertyValue('--gantt-font-color')||'').trim(); if(c) fontColor.value = c; }
  }catch(_){}

  function persist(){ 
    const obj = { leftW: getComputedStyle(root).getPropertyValue('--gantt-left-w').trim(),
      gcol: getNumVar('--gcol', 20),
      rowH: getNumVar('--row-h', 36),
      barH: getNumVar('--bar-h', 22),
      fontSize: getNumVar('--gantt-font-size', 12),
      fontFamily: getComputedStyle(root).getPropertyValue('--gantt-font-family').trim(),
      fontWeight: getComputedStyle(root).getPropertyValue('--gantt-font-weight').trim(),
      fontColor: getComputedStyle(root).getPropertyValue('--gantt-font-color').trim(),
      ganttW: getComputedStyle(root).getPropertyValue('--gantt-w').trim()
    };
    try{ localStorage.setItem(prefsKey, JSON.stringify(obj)); }catch(_){}
  }

  function refreshGantt(){ try{ renderGantt(); }catch(_){ } }

  if (zoomSlider){
    const applyZoom = (val)=>{ setVar('--gcol', Math.max(12, Math.min(60, Number(val)))); window.persist && window.persist(); refreshGantt(); };
    zoomSlider.addEventListener('input', (e)=> applyZoom(e.target.value));
    if (zoomInBtn) zoomInBtn.addEventListener('click', ()=>{ zoomSlider.value = Math.min(60, Number(zoomSlider.value||20)+2); zoomSlider.dispatchEvent(new Event('input')); });
    if (zoomOutBtn) zoomOutBtn.addEventListener('click', ()=>{ zoomSlider.value = Math.max(12, Number(zoomSlider.value||20)-2); zoomSlider.dispatchEvent(new Event('input')); });
  }
  if (rowHeight){ rowHeight.addEventListener('input', (e)=>{ setVar('--row-h', Number(e.target.value)); window.persist && window.persist(); refreshGantt(); }); }
  
  if (fontSize){ fontSize.addEventListener('input', (e)=>{ setVar('--gantt-font-size', Number(e.target.value)); window.persist && window.persist(); }); }
  if (fontFamily){ fontFamily.addEventListener('change', (e)=>{ setVar('--gantt-font-family', e.target.value); window.persist && window.persist(); }); }
  
  if (fontColor){ fontColor.addEventListener('input', ()=>{ setVar('--gantt-font-color', fontColor.value); window.persist && window.persist(); }); }

  // Resize handle: drag to change --gantt-w (affects whole app width)
  const handle = document.getElementById('ganttResize');
  if (handle){
    let sx=0, sw=0, dragging=false;
    const minW = 420, maxW = 2000;
    function numberFromVar(val, fallback){
      const n = parseFloat(val||''); return Number.isFinite(n) ? n : fallback;
    }
    handle.addEventListener('mousedown', (e)=>{
      e.preventDefault(); dragging=true; sx = e.clientX;
      const used = getComputedStyle(root).getPropertyValue('--gantt-w').trim();
      sw = numberFromVar(used, (document.querySelector('.gantt-shell')?.clientWidth || 860));
      document.body.classList.add('noselect');
    });
    window.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      const dx = e.clientX - sx;
      const w = Math.max(minW, Math.min(maxW, sw + dx));
      setVar('--gantt-w', w); window.persist && window.persist();
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.classList.remove('noselect'); });
    handle.addEventListener('dblclick', ()=>{ setVar('--gantt-w', 860); window.persist && window.persist(); });
  }
})();

</script>

<div id="dayColorMenu" class="context-menu" aria-hidden="true" hidden>
  <div class="swatches" id="dayColorSwatches">
    <button class="swatch" data-color="#74FBD6" title="Mint"></button>
    <button class="swatch" data-color="#2EA1FF" title="Azure"></button>
    <button class="swatch" data-color="#A88BEB" title="Lavender"></button>
    <button class="swatch" data-color="#FF9EC4" title="Pink"></button>
    <button class="swatch" data-color="#FFD166" title="Amber"></button>
    <button class="swatch" data-color="#7CF29C" title="Lime"></button>
    <button class="swatch" data-color="#6C63FF" title="Indigo"></button>
    <button class="swatch" data-color="#FF7A59" title="Coral"></button>
  </div>
  <div class="tools" id="dayColorTools">
    <input type="color" id="dayColorPicker" value="#2EA1FF" />
    <button id="dayColorClear" type="button">Clear</button>
  </div>
</div>

<div id="ganttCtx" class="gctx">
  <div class="item" data-action="delete">Delete task</div>
</div>

<div id="stageCtx" class="gctx">
  <div class="item" data-action="rename">Rename stage</div>
  <div class="item" data-action="delete">Delete stage</div>
  <div class="item" data-action="create">Create new stage</div>
</div>


<script>
// Global fallback: persist current Gantt UI prefs to localStorage
if (typeof window.persistGanttPrefs !== 'function') {
  window.persistGanttPrefs = function(){
    try{
      var root = document.documentElement;
      function num(name, fallback){
        var v = getComputedStyle(root).getPropertyValue(name).trim();
        var n = parseFloat(v||''); return isFinite(n) ? n : fallback;
      }
      var obj = {
        gcol: num('--gcol', 20),
        rowH: num('--row-h', 36),
        barH: num('--bar-h', 22),
        fontSize: num('--gantt-font-size', 12),
        fontFamily: getComputedStyle(root).getPropertyValue('--gantt-font-family').trim(),
        fontWeight: getComputedStyle(root).getPropertyValue('--gantt-font-weight').trim(),
        fontColor: getComputedStyle(root).getPropertyValue('--gantt-font-color').trim(),
        ganttW: getComputedStyle(root).getPropertyValue('--gantt-w').trim(),
        leftW: getComputedStyle(root).getPropertyValue('--gantt-left-w').trim()
      };
      localStorage.setItem('GANTT_UI_PREFS_V1', JSON.stringify(obj));
    }catch(e){ /* no-op */ }
  };
}
// Provide 'persist' alias for any call sites
if (typeof window.persist !== 'function') {
  window.persist = window.persistGanttPrefs;
}
</script>

</body>
</html>
